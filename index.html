<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#FBFBFD">
    <title>SoulDiary Pro | Apple Style å¿ƒç†å¥åº·å¹³å°</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React å’Œç›¸é—œåº« -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Google Generative AI SDK -->
    <script src="https://unpkg.com/@google/generative-ai"></script>
    
    <!-- Lucide React Icons -->
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>
    
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Lottie for animations -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'sage': '#86A789',
                        'lavender': '#B2A4FF',
                        'primary': '#1D1D1F',
                        'background': '#FBFBFD',
                        'surface': '#FFFFFF',
                        'border-light': 'rgba(0,0,0,0.08)',
                        'border-dark': 'rgba(255,255,255,0.1)',
                        'slate': {
                            100: '#F5F5F7',
                            200: '#E5E5E7',
                            300: '#D2D2D7',
                            400: '#8E8E93',
                            500: '#6E6E73',
                            600: '#424245',
                            700: '#1D1D1F',
                        }
                    },
                    fontFamily: {
                        'sans': ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                        'mono': ['SF Mono', 'Monaco', 'monospace'],
                    },
                    letterSpacing: {
                        'tight': '-0.02em',
                        'normal': '0em',
                        'wide': '0.02em',
                        'wider': '0.04em',
                        'widest': '0.08em',
                    },
                    animation: {
                        'stagger-fade-in': 'staggerFadeIn 0.6s ease-out forwards',
                        'fade-in-up': 'fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1)',
                        'fade-in': 'fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1)',
                        'scale-in': 'scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                        'slide-in-right': 'slideInRight 0.5s cubic-bezier(0.4, 0, 0.2, 1)',
                        'slide-in-left': 'slideInLeft 0.5s cubic-bezier(0.4, 0, 0.2, 1)',
                        'soft-pulse': 'softPulse 2s cubic-bezier(0.4, 0, 0.2, 1) infinite',
                        'breathing': 'breathing 4s ease-in-out infinite',
                        'number-scroll': 'numberScroll 1.5s cubic-bezier(0.4, 0, 0.2, 1) forwards',
                        'text-focus-in': 'textFocusIn 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards',
                    },
                    keyframes: {
                        staggerFadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        scaleIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        slideInRight: {
                            '0%': { opacity: '0', transform: 'translateX(30px)' },
                            '100%': { opacity: '1', transform: 'translateX(0)' },
                        },
                        slideInLeft: {
                            '0%': { opacity: '0', transform: 'translateX(-30px)' },
                            '100%': { opacity: '1', transform: 'translateX(0)' },
                        },
                        softPulse: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.7' },
                        },
                        breathing: {
                            '0%, 100%': { opacity: '0.8', transform: 'scale(1)' },
                            '50%': { opacity: '1', transform: 'scale(1.02)' },
                        },
                        numberScroll: {
                            '0%': { transform: 'translateY(100%)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        textFocusIn: {
                            '0%': { filter: 'blur(12px)', opacity: '0' },
                            '100%': { filter: 'blur(0px)', opacity: '1' },
                        }
                    },
                    transitionTimingFunction: {
                        'apple': 'cubic-bezier(0.4, 0, 0.2, 1)',
                    }
                }
            }
        }
    </script>
    
    <style>
        /* åŸºç¤é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* å…¨å±€æ¨£å¼ */
        body {
            background-color: #FBFBFD;
            color: #1D1D1F;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica Neue, Arial, sans-serif;
            letter-spacing: -0.02em;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .dark body {
            background-color: #161617;
            color: #FBFBFD;
        }
        
        /* å®¹å™¨æ¨£å¼ */
        .container-apple {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
        }
        
        /* å¡ç‰‡æ¨£å¼ */
        .card-apple {
            background-color: #FFFFFF;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 18px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.04);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .dark .card-apple {
            background-color: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
        }
        
        .card-apple:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
        }
        
        .dark .card-apple:hover {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }
        
        /* æŒ‰éˆ•ç‰©ç†åé¥‹ */
        .button-apple {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .button-apple:active {
            transform: scale(0.95);
        }
        
        /* å°èˆªæ¬„æ¨¡ç³Šæ•ˆæœ */
        .navbar-blur {
            background-color: rgba(251, 251, 253, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        .dark .navbar-blur {
            background-color: rgba(22, 22, 23, 0.8);
        }
        
        /* è»Ÿæ€§è¼¸å…¥æ¡† */
        .input-apple {
            background-color: rgba(0, 0, 0, 0.02);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 16px;
            line-height: 1.5;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .dark .input-apple {
            background-color: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
            color: #FBFBFD;
        }
        
        .input-apple:focus {
            outline: none;
            border-color: #1D1D1F;
            box-shadow: 0 0 0 3px rgba(29, 29, 31, 0.1);
        }
        
        .dark .input-apple:focus {
            border-color: #B2A4FF;
            box-shadow: 0 0 0 3px rgba(178, 164, 255, 0.2);
        }
        
        /* å°è©±æ³¡æ³¡ */
        .message-bubble-user {
            background: linear-gradient(135deg, #B2A4FF 0%, #9A8BFF 100%);
            color: white;
            border-radius: 20px 20px 6px 20px;
        }
        
        .message-bubble-ai {
            background-color: #F5F5F7;
            color: #1D1D1F;
            border-radius: 20px 20px 20px 6px;
        }
        
        .dark .message-bubble-ai {
            background-color: rgba(255, 255, 255, 0.08);
            color: #FBFBFD;
        }
        
        /* é€²åº¦æ¢ */
        .progress-bar-apple {
            height: 4px;
            background-color: rgba(0, 0, 0, 0.08);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .dark .progress-bar-apple {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .progress-fill-apple {
            height: 100%;
            background: linear-gradient(90deg, #86A789 0%, #B2A4FF 100%);
            border-radius: 2px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* è† å›Šå‹é€²åº¦æ¢ */
        .capsule-progress {
            height: 3px;
            background-color: rgba(0, 0, 0, 0.08);
            border-radius: 1.5px;
            overflow: hidden;
        }
        
        .dark .capsule-progress {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .capsule-fill {
            height: 100%;
            background: linear-gradient(90deg, #86A789 0%, #B2A4FF 100%);
            border-radius: 1.5px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* æ¨™ç±¤æ¨£å¼ */
        .tag-sage {
            background-color: rgba(134, 167, 137, 0.1);
            color: #86A789;
            border: 1px solid rgba(134, 167, 137, 0.2);
        }
        
        .tag-lavender {
            background-color: rgba(178, 164, 255, 0.1);
            color: #B2A4FF;
            border: 1px solid rgba(178, 164, 255, 0.2);
        }
        
        /* è¼‰å…¥å‹•ç•« */
        .loading-dots-apple {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .loading-dots-apple span {
            width: 6px;
            height: 6px;
            background-color: currentColor;
            border-radius: 50%;
            animation: softPulse 1.4s cubic-bezier(0.4, 0, 0.2, 1) infinite both;
        }
        
        .loading-dots-apple span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .loading-dots-apple span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        /* æ¨™è¨˜å…§å®¹æ¨£å¼ */
        .markdown-content h1 { 
            font-size: 1.5em; 
            font-weight: 600; 
            margin: 1.5em 0 0.75em; 
            letter-spacing: -0.03em;
        }
        
        .markdown-content h2 { 
            font-size: 1.25em; 
            font-weight: 600; 
            margin: 1.25em 0 0.625em; 
            letter-spacing: -0.02em;
        }
        
        .markdown-content p { 
            margin-bottom: 1.25em; 
            line-height: 1.7;
        }
        
        .markdown-content ul, .markdown-content ol { 
            padding-left: 1.5em; 
            margin-bottom: 1.25em; 
        }
        
        .markdown-content li { 
            margin-bottom: 0.5em; 
        }
        
        .markdown-content blockquote { 
            border-left: 3px solid rgba(178, 164, 255, 0.3); 
            padding-left: 1em; 
            margin: 1.5em 0; 
            color: #6E6E73;
            font-style: italic;
        }
        
        .dark .markdown-content blockquote {
            color: #8E8E93;
        }
        
        .markdown-content code { 
            background-color: rgba(0, 0, 0, 0.05); 
            padding: 2px 6px; 
            border-radius: 6px; 
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.9em;
        }
        
        .dark .markdown-content code {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .markdown-content pre { 
            background-color: rgba(0, 0, 0, 0.05); 
            padding: 1.25em; 
            border-radius: 12px; 
            overflow-x: auto;
            margin: 1.5em 0;
        }
        
        .dark .markdown-content pre {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        /* è‡ªè¨‚æ»¾å‹•æ¢ */
        .scrollbar-apple::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        .scrollbar-apple::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 3px;
        }
        
        .scrollbar-apple::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }
        
        .dark .scrollbar-apple::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .scrollbar-apple::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.2);
        }
        
        .dark .scrollbar-apple::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 768px) {
            .container-apple {
                padding: 0 16px;
            }
            
            .card-apple {
                border-radius: 14px;
            }
        }
        
        /* æ•¸å­—æ²å‹•æ•ˆæœ */
        .number-scroll-container {
            overflow: hidden;
            display: inline-block;
        }
        
        .number-scroll-digit {
            display: inline-block;
            animation: numberScroll 1.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        /* å‘¼å¸ç‡ˆå‹•ç•« */
        .breathing-light {
            animation: breathing 4s ease-in-out infinite;
        }
        
        /* Apple è¨­å®šåˆ—è¡¨æ¨£å¼ */
        .settings-section {
            background-color: #FFFFFF;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 16px;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }
        
        .dark .settings-section {
            background-color: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        .settings-item {
            padding: 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .dark .settings-item {
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }
        
        .settings-item:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        .dark .settings-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .settings-item:last-child {
            border-bottom: none;
        }
        
        .settings-item-content {
            flex: 1;
        }
        
        .settings-item-title {
            font-weight: 500;
            color: #1D1D1F;
            margin-bottom: 2px;
        }
        
        .dark .settings-item-title {
            color: #FBFBFD;
        }
        
        .settings-item-description {
            font-size: 14px;
            color: #6E6E73;
        }
        
        .dark .settings-item-description {
            color: #8E8E93;
        }
        
        /* é‡è¡¨å‹•ç•« */
        .question-slide-out {
            animation: slideOutLeft 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        .question-slide-in {
            animation: slideInRight 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        @keyframes slideOutLeft {
            0% { opacity: 1; transform: translateX(0) scale(1); }
            100% { opacity: 0; transform: translateX(-30px) scale(0.95); }
        }
        
        /* æ¼¸é€²å¼æ­éœ²å®¹å™¨ */
        .progressive-reveal-container {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1), transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .progressive-reveal-container.revealed {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-background text-primary transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        // ============================
        // é…ç½®å¸¸æ•¸
        // ============================
        
        // Gemini API é‡‘é‘°
        const GEMINI_API_KEY = "AIzaSyDbjD4uQxga8msmQejOSv-uFLXpFoT8eFs";
        
        // EPDS é‡è¡¨å•é¡Œ
        const EPDS_QUESTIONS = [
            "æˆ‘èƒ½çœ‹åˆ°äº‹ç‰©æœ‰è¶£çš„ä¸€é¢ï¼Œä¸¦ç¬‘å¾—é–‹å¿ƒ",
            "æˆ‘å°æœªä¾†ä¿æŒç©æ¥µæ…‹åº¦",
            "ç•¶äº‹æƒ…å‡ºéŒ¯æ™‚ï¼Œæˆ‘æœƒä¸å¿…è¦åœ°è²¬å‚™è‡ªå·±",
            "æˆ‘ç„¡ç·£ç„¡æ•…åœ°æ„Ÿåˆ°ç„¦æ…®æˆ–æ“”å¿ƒ",
            "æˆ‘ç„¡ç·£ç„¡æ•…åœ°æ„Ÿåˆ°ææ‡¼æˆ–ææ…Œ",
            "äº‹æƒ…è®Šå¾—è®“æˆ‘ç„¡æ³•æ‡‰ä»˜",
            "æˆ‘å¾ˆä¸é–‹å¿ƒï¼Œä»¥è‡´é›£ä»¥å…¥ç¡",
            "æˆ‘æ„Ÿåˆ°æ‚²å‚·æˆ–ç—›è‹¦",
            "æˆ‘å¦‚æ­¤ä¸é–‹å¿ƒï¼Œä»¥è‡´å“­æ³£",
            "æˆ‘æœ‰å‚·å®³è‡ªå·±çš„æƒ³æ³•"
        ];
        
        // æ²»ç™‚èª²ç¨‹è³‡æ–™
        const THERAPY_COURSES = [
            {
                id: "cbt-1",
                title: "è‡ªå‹•åŒ–æ€è€ƒæŒ‘æˆ°",
                description: "è­˜åˆ¥ä¸¦æŒ‘æˆ°è² é¢çš„è‡ªå‹•åŒ–æ€è€ƒæ¨¡å¼",
                category: "èªçŸ¥è¡Œç‚º",
                duration: "15åˆ†é˜",
                steps: 4,
                color: "sage",
                icon: "ğŸ§ "
            },
            {
                id: "cbt-2",
                title: "å„ªé»æ¸…å–®",
                description: "ç™¼æ˜ä¸¦è¨˜éŒ„å€‹äººçš„å„ªå‹¢èˆ‡é•·è™•",
                category: "èªçŸ¥è¡Œç‚º",
                duration: "10åˆ†é˜",
                steps: 4,
                color: "sage",
                icon: "ğŸ“"
            },
            {
                id: "mind-1",
                title: "3åˆ†é˜å‘¼å¸è§€ç…§",
                description: "é€éå°ˆæ³¨å‘¼å¸å›åˆ°ç•¶ä¸‹",
                category: "æ­£å¿µç·´ç¿’",
                duration: "3åˆ†é˜",
                steps: 4,
                color: "lavender",
                icon: "ğŸŒ¬ï¸"
            },
            {
                id: "mind-2",
                title: "èº«é«”æƒæ",
                description: "ç³»çµ±æ€§åœ°è¦ºå¯Ÿèº«é«”å„éƒ¨ä½",
                category: "æ­£å¿µç·´ç¿’",
                duration: "10åˆ†é˜",
                steps: 4,
                color: "lavender",
                icon: "ğŸ”"
            }
        ];
        
        // å¿ƒæƒ…æ¨™ç±¤
        const MOOD_TAGS = [
            "å¹³éœ", "å……æ»¿å¸Œæœ›", "æ„Ÿæ©", "æ»¿è¶³", "æœ‰æ´»åŠ›", "æ¨‚è§€",
            "ç–²æ†Š", "ä¸ç¢ºå®š", "å¹³æ·¡", "ç„¡æ„Ÿ",
            "ç„¦æ…®", "ä¸çŸ¥æ‰€æª", "ç…©èº", "æ²‰é‡", "å­¤å–®", "å£“åŠ›"
        ];
        
        // ============================
        // å·¥å…·å‡½æ•¸
        // ============================
        
        // SHA-256 å¯†ç¢¼é›œæ¹Š
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password + 'souldiary_apple_salt');
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        // åˆå§‹åŒ–æœ¬åœ°å„²å­˜
        function initializeStorage() {
            if (!localStorage.getItem('souldiary_users')) {
                localStorage.setItem('souldiary_users', JSON.stringify([]));
            }
            if (!localStorage.getItem('souldiary_entries')) {
                localStorage.setItem('souldiary_entries', JSON.stringify([]));
            }
            if (!localStorage.getItem('souldiary_courses')) {
                localStorage.setItem('souldiary_courses', JSON.stringify([]));
            }
            if (!localStorage.getItem('souldiary_assessments')) {
                localStorage.setItem('souldiary_assessments', JSON.stringify([]));
            }
            if (!localStorage.getItem('souldiary_chats')) {
                localStorage.setItem('souldiary_chats', JSON.stringify({}));
            }
        }
        
        // è¨ˆç®— EPDS åˆ†æ•¸
        function calculateEPDSScore(answers) {
            return Object.values(answers).reduce((sum, score) => sum + score, 0);
        }
        
        // ç²å– EPDS è©•ä¼°çµæœ
        function getEPDSResult(score) {
            if (score <= 9) {
                return { 
                    level: "low",
                    message: "å¿ƒç†å¥åº·ç‹€æ³è‰¯å¥½",
                    color: "text-emerald-600",
                    bgColor: "bg-emerald-50",
                    recommendation: "ç¹¼çºŒä¿æŒå¥åº·çš„ç”Ÿæ´»ç¿’æ…£"
                };
            } else if (score <= 12) {
                return { 
                    level: "medium",
                    message: "å»ºè­°é—œæ³¨å¿ƒç†å¥åº·",
                    color: "text-amber-600",
                    bgColor: "bg-amber-50",
                    recommendation: "å»ºè­°é€²è¡Œè‡ªæˆ‘ç…§é¡§æˆ–å°‹æ±‚æ”¯æŒ"
                };
            } else {
                return { 
                    level: "high",
                    message: "å¼·çƒˆå»ºè­°å°‹æ±‚å°ˆæ¥­å”åŠ©",
                    color: "text-rose-600",
                    bgColor: "bg-rose-50",
                    recommendation: "å»ºè­°å„˜å¿«å°‹æ±‚å¿ƒç†å¥åº·å°ˆæ¥­äººå£«çš„å”åŠ©"
                };
            }
        }
        
        // ç²å–æ™‚é–“å•å€™èª
        function getTimeGreeting() {
            const hour = new Date().getHours();
            if (hour >= 5 && hour < 12) return "æ—©å®‰";
            if (hour >= 12 && hour < 18) return "åˆå®‰";
            if (hour >= 18 && hour < 23) return "æ™šå®‰";
            return "ç¥å¥½å¤¢";
        }
        
        // ç²å–å¿ƒæƒ…æè¿°
        function getMoodDescription(intensity) {
            if (intensity >= 8) return "éå¸¸æ„‰æ‚…ï¼Œå……æ»¿æ­£èƒ½é‡";
            if (intensity >= 6) return "æ„Ÿè¦ºè‰¯å¥½ï¼Œå¿ƒæƒ…ç©©å®š";
            if (intensity >= 4) return "å¹³éœæ”¾é¬†ï¼Œç‹€æ…‹æ™®é€š";
            if (intensity >= 2) return "æœ‰äº›ä½è½ï¼Œéœ€è¦é—œæ³¨";
            return "æƒ…ç·’ä½è½ï¼Œå»ºè­°ä¼‘æ¯";
        }
        
        // å¯¦é«” Gemini AI å›æ‡‰
        async function getGeminiResponse(userMessage, conversationHistory) {
            try {
                // åˆå§‹åŒ– Gemini
                const genAI = new google.generativeai.GenerativeAI(GEMINI_API_KEY);
                const model = genAI.getGenerativeModel({ model: "gemini-pro" });
                
                // å»ºç«‹ç³»çµ±æç¤ºè©
                const systemPrompt = `ä½ æ˜¯ä¸€ä½å…·å‚™è‡¨åºŠå¿ƒç†å­¸èƒŒæ™¯çš„å¿ƒç†å°å¸«ï¼Œèªæ°£å„ªé›…ã€æº«æš–ä¸”å°ˆæ¥­ã€‚è«‹ç”¨ä¸­æ–‡å›ç­”ï¼Œä¸¦é©åº¦ä½¿ç”¨ Markdown æ ¼å¼ï¼ˆå¦‚ç²—é«”ã€åˆ†é»å»ºè­°ï¼‰ä¾†çµ„ç¹”å…§å®¹ã€‚

è«‹éµå¾ªä»¥ä¸‹æŒ‡å°åŸå‰‡ï¼š
1. å±•ç¾å°ˆæ¥­å¿ƒç†å­¸çŸ¥è­˜ï¼Œä½†ä¿æŒæº«æš–è¦ªåˆ‡çš„èªæ°£
2. ä½¿ç”¨åŒç†å¿ƒå›æ‡‰ï¼Œé¿å…æ‰¹åˆ¤æ€§èªè¨€
3. æä¾›å…·é«”ã€å¯æ“ä½œçš„å¿ƒç†å¥åº·å»ºè­°
4. é©æ™‚ä½¿ç”¨ **ç²—é«”** å¼·èª¿é‡é»æ¦‚å¿µ
5. ä½¿ç”¨åˆ†é»å»ºè­°ï¼ˆå¦‚ 1. 2. 3.ï¼‰è®“å…§å®¹æ›´æ¸…æ™°
6. ä¿æŒå›è¦†çš„çµæ§‹æ€§ï¼Œä½†ä¸éæ–¼å­¸è¡“åŒ–

ç”¨æˆ¶è¨Šæ¯ï¼š${userMessage}`;
                
                // å»ºç«‹æ­·å²å°è©±ä¸Šä¸‹æ–‡
                let historyText = "";
                if (conversationHistory && conversationHistory.length > 0) {
                    historyText = "\n\nå°è©±æ­·å²ï¼š\n";
                    conversationHistory.slice(-5).forEach(msg => {
                        historyText += `${msg.role === 'user' ? 'ç”¨æˆ¶' : 'å¿ƒç†å°å¸«'}: ${msg.content}\n`;
                    });
                }
                
                const fullPrompt = systemPrompt + historyText;
                
                const result = await model.generateContent(fullPrompt);
                const response = await result.response;
                const text = response.text();
                
                return text;
            } catch (error) {
                console.error('Gemini API éŒ¯èª¤:', error);
                
                // é™ç´šæ–¹æ¡ˆï¼šå°ˆæ¥­çš„å¿ƒç†å¥åº·å›æ‡‰
                const fallbackResponses = [
                    `**æ‚¨å¥½ï¼Œæˆ‘æ˜¯æ‚¨çš„å¿ƒç†å°å¸«ã€‚** ä½œç‚ºä¸€ä½å…·å‚™è‡¨åºŠå¿ƒç†èƒŒæ™¯çš„å°ˆæ¥­å¤¥ä¼´ï¼Œæˆ‘æœƒä»¥æº«æš–ã€åŒç†å¿ƒçš„æ–¹å¼é™ªä¼´æ‚¨æ¢ç´¢å…§åœ¨ä¸–ç•Œã€‚

**é‡å°æ‚¨çš„æƒ…æ³ï¼Œæˆ‘å»ºè­°ï¼š**

1. **æƒ…ç·’è¦ºå¯Ÿç·´ç¿’**
   è©¦è‘—çµ¦ç•¶ä¸‹çš„æƒ…ç·’ä¸€å€‹åå­—ï¼Œç„¶å¾Œè§€å¯Ÿå®ƒåœ¨èº«é«”å“ªå€‹éƒ¨ä½æœ€æ˜é¡¯ã€‚

2. **æº«å’Œæ¥ç´**
   æƒ…ç·’æ²’æœ‰å¥½å£ä¹‹åˆ†ï¼Œå®ƒåªæ˜¯å…§å¿ƒçš„ä¿¡è™Ÿã€‚è©¦è‘—ä¸è©•åˆ¤åœ°æ¥ç´å®ƒçš„å­˜åœ¨ã€‚

3. **ç°¡å–®è¡Œå‹•**
   é¸æ“‡ä¸€ä»¶å¾®å°ä½†èƒ½å¸¶ä¾†æ»‹é¤Šæ„Ÿçš„äº‹ï¼Œæ¯”å¦‚ï¼š
   - å–æ¯æº«æ°´
   - æ·±å‘¼å¸ä¸‰æ¬¡
   - çœ‹å‘çª—å¤–30ç§’

**ä»Šå¤©çš„å°ç·´ç¿’ï¼š**
é–‰ä¸Šçœ¼ç›ï¼Œæ„Ÿå—ä¸‰æ¬¡å‘¼å¸çš„é€²å‡ºï¼Œç„¶å¾Œå°è‡ªå·±èªªï¼šã€Œæ­¤åˆ»çš„æˆ‘å·²ç¶“è¶³å¤ å¥½äº†ã€‚ã€

æƒ³å’Œæˆ‘å¤šèŠèŠæ‚¨çš„æ„Ÿå—å—ï¼Ÿ`,

                    `**æ„Ÿè¬æ‚¨åˆ†äº«æ­¤åˆ»çš„å¿ƒæƒ…ã€‚** ä½œç‚ºæ‚¨çš„å¿ƒç†å°å¸«ï¼Œæˆ‘æƒ³å…ˆè®“æ‚¨çŸ¥é“ï¼šæ‚¨ä¸¦ä¸å­¤å–®ï¼Œæƒ…ç·’çš„æ³¢å‹•æ˜¯äººæ€§çš„ä¸€éƒ¨åˆ†ã€‚

**ç«‹å³å¯ç”¨çš„æŠ€å·§ï¼š**

**5-4-3-2-1 æ„Ÿå®˜æ¥åœ°æ³•**
1. æ‰¾å‡ºæ‚¨å‘¨åœçš„ï¼š5æ¨£çœ‹åˆ°çš„æ±è¥¿
2. 4æ¨£è§¸æ‘¸åˆ°çš„æ±è¥¿
3. 3æ¨£è½åˆ°çš„è²éŸ³
4. 2ç¨®èåˆ°çš„æ°£å‘³
5. 1æ¨£åšåˆ°çš„å‘³é“

**èªçŸ¥èª¿æ•´ç·´ç¿’ï¼š**
ç„¦æ…®å¸¸å¸¸ä¾†è‡ªå°ã€Œä¸ç¢ºå®šæ€§ã€çš„æ“”æ†‚ã€‚è©¦è‘—å•è‡ªå·±ï¼š
1. é€™å€‹æ“”å¿ƒçš„äº‹ï¼Œç™¼ç”Ÿçš„æ©Ÿç‡æœ‰å¤šå¤§ï¼Ÿ
2. å¦‚æœçœŸçš„ç™¼ç”Ÿäº†ï¼Œæˆ‘æœ€èƒ½æ‡‰å°çš„æ–¹å¼æ˜¯ä»€éº¼ï¼Ÿ
3. **æ­¤åˆ»ï¼Œæˆ‘èƒ½å¤ æ§åˆ¶çš„æ˜¯ä»€éº¼ï¼Ÿ**

è«‹è¨˜å¾—ï¼Œæƒ…ç·’æ˜¯æˆ‘å€‘ä¿è­·è‡ªå·±çš„è¨Šè™Ÿï¼Œä¸æ˜¯æ•µäººã€‚`
                ];
                
                // æ ¹æ“šè¨Šæ¯å…§å®¹é¸æ“‡å›æ‡‰
                if (userMessage.includes('ç„¦æ…®') || userMessage.includes('ç·Šå¼µ') || userMessage.includes('æ“”å¿ƒ')) {
                    return `**æˆ‘æ„Ÿå—åˆ°æ‚¨å¯èƒ½æ­£ç¶“æ­·ç„¦æ…®æ™‚åˆ»ã€‚** ä½œç‚ºæ‚¨çš„å¿ƒç†å°å¸«ï¼Œæˆ‘æƒ³èˆ‡æ‚¨åˆ†äº«ä¸€äº›ç§‘å­¸é©—è­‰çš„æ–¹æ³•ï¼š

**ç«‹å³ç·©è§£æŠ€å·§ï¼š**

1. **ç›’å¼å‘¼å¸æ³•**
   - å¸æ°£ 4 ç§’ â†’ å±æ¯ 4 ç§’ â†’ å‘¼æ°£ 4 ç§’ â†’ å±æ¯ 4 ç§’
   - é‡è¤‡ 3-5 è¼ªï¼Œå°ˆæ³¨æ–¼å‘¼å¸çš„ç¯€å¥

2. **èº«é«”æƒæ**
   - å¾è…³è¶¾é–‹å§‹ï¼Œé€æ¼¸å‘ä¸Šè¦ºå¯Ÿæ¯å€‹èº«é«”éƒ¨ä½
   - ä¸è©•åˆ¤ä»»ä½•æ„Ÿè¦ºï¼Œåªæ˜¯è§€å¯Ÿ

**èªçŸ¥èª¿æ•´ï¼š**
ç„¦æ…®å¸¸å¸¸ä¾†è‡ªå°ã€Œæœªä¾†ä¸ç¢ºå®šæ€§ã€çš„æ“”æ†‚ã€‚è©¦è‘—å•è‡ªå·±ï¼š
- **é€™å€‹æ“”å¿ƒçš„äº‹ï¼Œæœ‰å¤šå¤§æ¦‚ç‡æœƒç™¼ç”Ÿï¼Ÿ**
- **å³ä½¿ç™¼ç”Ÿï¼Œæˆ‘èƒ½æ‡‰å°çš„æœ€æœ‰æ•ˆæ–¹å¼æ˜¯ä»€éº¼ï¼Ÿ**
- **æ­¤åˆ»ï¼Œæˆ‘èƒ½å¤ å¯¦éš›æ§åˆ¶çš„æ˜¯ä»€éº¼ï¼Ÿ**

**å°ˆæ¥­æé†’ï¼š**
å¦‚æœé€™äº›æ„Ÿå—æŒçºŒå½±éŸ¿æ—¥å¸¸ç”Ÿæ´»ï¼Œå»ºè­°è€ƒæ…®å°‹æ±‚å°ˆæ¥­å¿ƒç†å¸«çš„å”åŠ©ã€‚æ‚¨å€¼å¾—æœ€å¥½çš„ç…§é¡§ã€‚`;
                } else if (userMessage.includes('ä½è½') || userMessage.includes('æ†‚é¬±') || userMessage.includes('æ‚²å‚·')) {
                    return `**æ„Ÿè¬æ‚¨é¡˜æ„åˆ†äº«æ­¤åˆ»çš„ä½è½æ„Ÿã€‚** ä½œç‚ºæ‚¨çš„å¿ƒç†å°å¸«ï¼Œæˆ‘æƒ³å…ˆè®“æ‚¨çŸ¥é“ï¼šæƒ…ç·’çš„ä½è°·æ˜¯äººæ€§çš„ä¸€éƒ¨åˆ†ï¼Œæ‚¨æ­¤åˆ»çš„æ„Ÿå—æ˜¯æœ‰æ•ˆä¸”é‡è¦çš„ã€‚

**æ­¤åˆ»çš„å»ºè­°ï¼š**

**1. å¾®å°è¡Œå‹•ç­–ç•¥**
   å³ä½¿æ²’æœ‰å‹•åŠ›ï¼Œä¹Ÿå¯ä»¥é¸æ“‡ä¸€å€‹æ¥µå°çš„è¡Œå‹•ï¼š
   - åèµ·ä¾†æ·±å‘¼å¸ä¸‰æ¬¡
   - å–ä¸€å£æº«æ°´
   - çœ‹å‘çª—å¤–30ç§’

**2. è‡ªæˆ‘æ…ˆæ‚²ç·´ç¿’**
   å°è‡ªå·±èªªï¼šã€Œæ­¤åˆ»çš„å›°é›£æ˜¯çœŸå¯¦çš„ï¼Œæˆ‘å…è¨±è‡ªå·±æ„Ÿå—é€™äº›æƒ…ç·’ã€‚ã€

**3. æ”¯æŒç³»çµ±é€£çµ**
   å¦‚æœæ‚¨é¡˜æ„ï¼Œå¯ä»¥ï¼š
   - èˆ‡ä¸€ä½ä¿¡ä»»çš„äººç°¡å–®è¯ç¹«
   - æˆ–ç¹¼çºŒèˆ‡æˆ‘å°è©±

**é‡è¦å°ˆæ¥­æé†’ï¼š**
å¦‚æœé€™äº›ä½è½æ„ŸæŒçºŒè¶…éå…©é€±ï¼Œæˆ–æ˜é¡¯å½±éŸ¿æ—¥å¸¸åŠŸèƒ½ï¼Œ**å¼·çƒˆå»ºè­°è¯ç¹«å°ˆæ¥­å¿ƒç†å¸«æˆ–ç²¾ç¥ç§‘é†«å¸«**ã€‚å¿ƒç†å¥åº·èˆ‡èº«é«”å¥åº·åŒæ¨£é‡è¦ï¼Œæ‚¨å€¼å¾—å°ˆæ¥­çš„å”åŠ©èˆ‡æ”¯æŒã€‚`;
                }
                
                return fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
            }
        }
        
        // ============================
        // React å…ƒä»¶
        // ============================
        
        // Logo å…ƒä»¶
        function LogoApple() {
            return (
                <div className="flex items-center space-x-3">
                    <div className="relative">
                        <div className="w-8 h-8 rounded-full border border-primary/20 flex items-center justify-center">
                            <div className="w-5 h-5 rounded-full border border-primary/40 flex items-center justify-center">
                                <div className="w-2 h-2 rounded-full bg-lavender"></div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div className="text-lg font-semibold tracking-wide text-primary">SoulDiary</div>
                        <div className="text-xs tracking-widest text-primary/40">PRO</div>
                    </div>
                </div>
            );
        }
        
        // é ‚éƒ¨å°èˆªåˆ—å…ƒä»¶
        function NavbarApple({ user, currentView, onNavigate, onLogout }) {
            const navItems = [
                { id: 'dashboard', label: 'é¦–é ', icon: 'ğŸ ' },
                { id: 'mood', label: 'å¿ƒæƒ…', icon: 'ğŸ’­' },
                { id: 'chat', label: 'AI å°è©±', icon: 'ğŸ¤–' },
                { id: 'assessment', label: 'è©•ä¼°', icon: 'ğŸ“Š' },
                { id: 'courses', label: 'èª²ç¨‹', icon: 'ğŸ§˜' },
                { id: 'settings', label: 'è¨­å®š', icon: 'âš™ï¸' }
            ];
            
            const [showDropdown, setShowDropdown] = React.useState(false);
            
            return (
                <nav className="sticky top-0 z-50 navbar-blur border-b border-border-light/50 dark:border-border-dark">
                    <div className="container-apple">
                        <div className="flex items-center justify-between h-16">
                            {/* Logo */}
                            <button onClick={() => onNavigate('dashboard')} className="button-apple">
                                <LogoApple />
                            </button>
                            
                            {/* å°èˆªé …ç›® */}
                            <div className="hidden md:flex items-center space-x-1">
                                {navItems.map((item) => (
                                    <button
                                        key={item.id}
                                        onClick={() => onNavigate(item.id)}
                                        className={`button-apple px-5 py-2.5 text-sm font-medium rounded-2xl transition-all duration-300 ${
                                            currentView === item.id
                                                ? 'bg-slate-100 dark:bg-white/10 text-primary dark:text-white'
                                                : 'text-primary/70 hover:text-primary hover:bg-black/5 dark:text-white/70 dark:hover:text-white dark:hover:bg-white/5'
                                        }`}
                                    >
                                        {item.label}
                                    </button>
                                ))}
                            </div>
                            
                            {/* ç”¨æˆ¶é ­åƒèˆ‡è¨­å®š */}
                            <div className="flex items-center space-x-3">
                                <div className="relative">
                                    <button
                                        onClick={() => setShowDropdown(!showDropdown)}
                                        className="button-apple flex items-center space-x-2 focus:outline-none"
                                    >
                                        <div className="w-9 h-9 rounded-full bg-gradient-to-br from-sage to-lavender flex items-center justify-center overflow-hidden">
                                            <span className="text-white font-medium text-sm">
                                                {user?.name?.charAt(0) || 'U'}
                                            </span>
                                        </div>
                                    </button>
                                    
                                    {showDropdown && (
                                        <div className="absolute right-0 mt-2 w-48 card-apple border border-border-light/50 dark:border-border-dark overflow-hidden animate-scale-in">
                                            <div className="p-2">
                                                <div className="px-3 py-2.5 text-sm text-primary/70 dark:text-white/70">
                                                    {user?.name}
                                                </div>
                                                <button
                                                    onClick={() => {
                                                        onNavigate('settings');
                                                        setShowDropdown(false);
                                                    }}
                                                    className="button-apple w-full text-left px-3 py-2.5 text-sm text-primary dark:text-white hover:bg-slate-100 dark:hover:bg-white/5 rounded-lg"
                                                >
                                                    å¸³æˆ¶è¨­å®š
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        onLogout();
                                                        setShowDropdown(false);
                                                    }}
                                                    className="button-apple w-full text-left px-3 py-2.5 text-sm text-rose-600 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-lg"
                                                >
                                                    ç™»å‡º
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </nav>
            );
        }
        
        // ç™»å…¥/è¨»å†Šé é¢å…ƒä»¶
        function AuthViewApple({ onLogin }) {
            const [isLogin, setIsLogin] = React.useState(true);
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [name, setName] = React.useState('');
            const [error, setError] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                
                try {
                    if (!email || !password) {
                        throw new Error('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
                    }
                    
                    if (password.length < 6) {
                        throw new Error('å¯†ç¢¼å¿…é ˆè‡³å°‘6å€‹å­—å…ƒ');
                    }
                    
                    const hashedPassword = await hashPassword(password);
                    
                    if (isLogin) {
                        const users = JSON.parse(localStorage.getItem('souldiary_users')) || [];
                        const user = users.find(u => u.email === email && u.password === hashedPassword);
                        
                        if (!user) {
                            throw new Error('é›»å­éƒµä»¶æˆ–å¯†ç¢¼éŒ¯èª¤');
                        }
                        
                        localStorage.setItem('souldiary_currentUser', JSON.stringify(user));
                        onLogin(user);
                        
                    } else {
                        if (!name) {
                            throw new Error('è«‹è¼¸å…¥å§“å');
                        }
                        
                        const users = JSON.parse(localStorage.getItem('souldiary_users')) || [];
                        const existingUser = users.find(u => u.email === email);
                        
                        if (existingUser) {
                            throw new Error('æ­¤é›»å­éƒµä»¶å·²è¢«è¨»å†Š');
                        }
                        
                        const newUser = {
                            id: Date.now().toString(),
                            name,
                            email,
                            password: hashedPassword,
                            createdAt: new Date().toISOString()
                        };
                        
                        users.push(newUser);
                        localStorage.setItem('souldiary_users', JSON.stringify(users));
                        localStorage.setItem('souldiary_currentUser', JSON.stringify(newUser));
                        
                        onLogin(newUser);
                    }
                    
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };
            
            return (
                <div className="min-h-screen flex items-center justify-center px-4 bg-background">
                    <div className="max-w-md w-full">
                        <div className="text-center mb-12 animate-fade-in-up">
                            <div className="mb-8">
                                <LogoApple />
                            </div>
                            <h1 className="text-3xl font-semibold tracking-tight text-primary mb-3">
                                {isLogin ? 'æ­¡è¿å›ä¾†' : 'åŠ å…¥ SoulDiary'}
                            </h1>
                            <p className="text-primary/60 tracking-wide">
                                {isLogin ? 'ç™»å…¥ä»¥ç¹¼çºŒæ‚¨çš„å¿ƒç†å¥åº·æ—…ç¨‹' : 'é–‹å§‹æ‚¨çš„å€‹æ€§åŒ–å¿ƒç†å¥åº·æ—…ç¨‹'}
                            </p>
                        </div>
                        
                        <div className="card-apple p-8 animate-fade-in-up" style={{ animationDelay: '0.1s' }}>
                            <div className="flex border-b border-border-light dark:border-border-dark mb-8">
                                <button
                                    onClick={() => setIsLogin(true)}
                                    className={`flex-1 pb-4 text-center font-medium transition-colors ${
                                        isLogin
                                            ? 'text-primary border-b-2 border-primary'
                                            : 'text-primary/50 hover:text-primary/70'
                                    }`}
                                >
                                    ç™»å…¥
                                </button>
                                <button
                                    onClick={() => setIsLogin(false)}
                                    className={`flex-1 pb-4 text-center font-medium transition-colors ${
                                        !isLogin
                                            ? 'text-primary border-b-2 border-primary'
                                            : 'text-primary/50 hover:text-primary/70'
                                    }`}
                                >
                                    è¨»å†Š
                                </button>
                            </div>
                            
                            {error && (
                                <div className="mb-6 p-4 bg-rose-50 dark:bg-rose-900/20 border border-rose-200 dark:border-rose-800 rounded-2xl animate-fade-in">
                                    <p className="text-sm text-rose-700 dark:text-rose-300">{error}</p>
                                </div>
                            )}
                            
                            <form onSubmit={handleSubmit}>
                                {!isLogin && (
                                    <div className="mb-5">
                                        <label className="block text-sm font-medium text-primary/70 mb-2 tracking-wide">
                                            å§“å
                                        </label>
                                        <input
                                            type="text"
                                            value={name}
                                            onChange={(e) => setName(e.target.value)}
                                            className="input-apple w-full"
                                            placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å"
                                        />
                                    </div>
                                )}
                                
                                <div className="mb-5">
                                    <label className="block text-sm font-medium text-primary/70 mb-2 tracking-wide">
                                        é›»å­éƒµä»¶
                                    </label>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        className="input-apple w-full"
                                        placeholder="your@email.com"
                                    />
                                </div>
                                
                                <div className="mb-8">
                                    <label className="block text-sm font-medium text-primary/70 mb-2 tracking-wide">
                                        å¯†ç¢¼
                                    </label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="input-apple w-full"
                                        placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                                    />
                                    {!isLogin && (
                                        <p className="mt-2 text-xs text-primary/40 tracking-wide">
                                            å¯†ç¢¼å°‡ä½¿ç”¨ SHA-256 ç«¯å°ç«¯åŠ å¯†
                                        </p>
                                    )}
                                </div>
                                
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="button-apple w-full py-3.5 px-4 bg-primary text-white font-medium rounded-2xl hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary/30 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {loading ? (
                                        <span className="loading-dots-apple">
                                            <span></span><span></span><span></span>
                                        </span>
                                    ) : isLogin ? 'ç™»å…¥' : 'è¨»å†Šå¸³æˆ¶'}
                                </button>
                            </form>
                            
                            <div className="mt-8 pt-8 border-t border-border-light dark:border-border-dark text-center text-sm text-primary/40 tracking-wide">
                                <p>ç«¯å°ç«¯åŠ å¯† Â· æ•¸æ“šæ°¸ä¸é›¢é–‹æ‚¨çš„è£ç½®</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        
        // å„€è¡¨æ¿ Hero å…ƒä»¶
        function DashboardHero({ user, recentMood }) {
            const [currentGreeting, setCurrentGreeting] = React.useState(getTimeGreeting());
            
            React.useEffect(() => {
                const interval = setInterval(() => {
                    setCurrentGreeting(getTimeGreeting());
                }, 60000);
                
                return () => clearInterval(interval);
            }, []);
            
            return (
                <div className="mb-12 animate-fade-in-up">
                    <div className="flex items-start justify-between mb-6">
                        <div>
                            <h1 className="text-4xl font-semibold tracking-tight text-primary mb-2">
                                {currentGreeting}ï¼Œ{user?.name || 'æœ‹å‹'}
                            </h1>
                            <p className="text-lg text-primary/60 tracking-wide">
                                ä»Šå¤©æ˜¯ç…§é¡§è‡ªå·±çš„å¥½æ—¥å­
                            </p>
                        </div>
                    </div>
                    
                    {/* å¿ƒæƒ…å¤©æ°£å°çµ„ä»¶ */}
                    {recentMood && (
                        <div className="card-apple p-6 animate-fade-in-up" style={{ animationDelay: '0.1s' }}>
                            <div className="flex items-start justify-between mb-4">
                                <div>
                                    <h3 className="text-lg font-semibold text-primary mb-1">å¿ƒæƒ…å¤©æ°£</h3>
                                    <p className="text-sm text-primary/50 tracking-wide">æœ€è¿‘ä¸€æ¬¡è¨˜éŒ„</p>
                                </div>
                                <div className="text-2xl">
                                    {recentMood.intensity >= 8 ? 'â˜€ï¸' : 
                                     recentMood.intensity >= 6 ? 'â›…' : 
                                     recentMood.intensity >= 4 ? 'ğŸŒ¤ï¸' : 'ğŸŒ§ï¸'}
                                </div>
                            </div>
                            
                            <div className="flex items-center justify-between">
                                <div>
                                    <div className="text-5xl font-semibold text-primary mb-1">
                                        {recentMood.intensity}<span className="text-2xl text-primary/40">/10</span>
                                    </div>
                                    <p className="text-sm text-primary/60">
                                        {getMoodDescription(recentMood.intensity)}
                                    </p>
                                </div>
                                
                                <div className="flex flex-wrap gap-1">
                                    {recentMood.tags?.slice(0, 3).map((tag, index) => (
                                        <span 
                                            key={index}
                                            className="px-3 py-1 text-xs tag-lavender rounded-full"
                                        >
                                            {tag}
                                        </span>
                                    ))}
                                </div>
                            </div>
                            
                            <div className="mt-6">
                                <div className="progress-bar-apple">
                                    <div 
                                        className="progress-fill-apple"
                                        style={{ width: `${recentMood.intensity * 10}%` }}
                                    ></div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        
        // æ¼¸é€²å¼æ­éœ²å®¹å™¨å…ƒä»¶
        function ProgressiveRevealContainer({ children, threshold = 0.1 }) {
            const [isRevealed, setIsRevealed] = React.useState(false);
            const containerRef = React.useRef(null);
            
            React.useEffect(() => {
                const observer = new IntersectionObserver(
                    ([entry]) => {
                        if (entry.isIntersecting) {
                            setIsRevealed(true);
                            observer.unobserve(entry.target);
                        }
                    },
                    { threshold }
                );
                
                if (containerRef.current) {
                    observer.observe(containerRef.current);
                }
                
                return () => {
                    if (containerRef.current) {
                        observer.unobserve(containerRef.current);
                    }
                };
            }, [threshold]);
            
            return (
                <div 
                    ref={containerRef}
                    className={`progressive-reveal-container ${isRevealed ? 'revealed' : ''}`}
                >
                    {children}
                </div>
            );
        }
        
        // æ­·å²è¶¨å‹¢å…ƒä»¶
        function HistoryTrends({ moodEntries }) {
            const [selectedPeriod, setSelectedPeriod] = React.useState('week');
            
            if (moodEntries.length === 0) {
                return (
                    <ProgressiveRevealContainer>
                        <div className="card-apple p-6">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-lg font-semibold text-primary">å¿ƒæƒ…è¶¨å‹¢</h3>
                                <div className="flex space-x-1">
                                    {['week', 'month', 'year'].map((period) => (
                                        <button
                                            key={period}
                                            onClick={() => setSelectedPeriod(period)}
                                            className={`button-apple px-3 py-1 text-xs rounded-full ${
                                                selectedPeriod === period
                                                    ? 'bg-primary text-white'
                                                    : 'bg-slate-100 text-primary/70 hover:bg-slate-200'
                                            }`}
                                        >
                                            {period === 'week' ? 'é€±' : period === 'month' ? 'æœˆ' : 'å¹´'}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="text-center py-8">
                                <div className="text-3xl text-primary/20 mb-3">ğŸ“ˆ</div>
                                <p className="text-primary/40">å°šç„¡è¶³å¤ çš„æ­·å²ç´€éŒ„</p>
                                <p className="text-sm text-primary/30 mt-1">é–‹å§‹è¨˜éŒ„å¿ƒæƒ…ä»¥æŸ¥çœ‹è¶¨å‹¢</p>
                            </div>
                        </div>
                    </ProgressiveRevealContainer>
                );
            }
            
            // è¨ˆç®—å¹³å‡å¿ƒæƒ…åˆ†æ•¸
            const averageMood = moodEntries.length > 0 
                ? (moodEntries.reduce((sum, entry) => sum + entry.intensity, 0) / moodEntries.length).toFixed(1)
                : 0;
            
            return (
                <ProgressiveRevealContainer>
                    <div className="card-apple p-6">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-lg font-semibold text-primary">å¿ƒæƒ…è¶¨å‹¢</h3>
                            <div className="flex space-x-1">
                                {['week', 'month', 'year'].map((period) => (
                                    <button
                                        key={period}
                                        onClick={() => setSelectedPeriod(period)}
                                        className={`button-apple px-3 py-1 text-xs rounded-full ${
                                            selectedPeriod === period
                                                ? 'bg-primary text-white'
                                                : 'bg-slate-100 text-primary/70 hover:bg-slate-200'
                                        }`}
                                    >
                                        {period === 'week' ? 'é€±' : period === 'month' ? 'æœˆ' : 'å¹´'}
                                    </button>
                                ))}
                            </div>
                        </div>
                        
                        <div className="mb-6">
                            <div className="flex items-end justify-between mb-2">
                                <div>
                                    <div className="text-3xl font-semibold text-primary">{averageMood}</div>
                                    <div className="text-sm text-primary/50">å¹³å‡å¿ƒæƒ…åˆ†æ•¸</div>
                                </div>
                                <div className="text-right">
                                    <div className="text-lg font-semibold text-primary">{moodEntries.length}</div>
                                    <div className="text-sm text-primary/50">ç¸½è¨˜éŒ„æ¬¡æ•¸</div>
                                </div>
                            </div>
                            
                            {/* ç°¡åŒ–çš„è¶¨å‹¢åœ– */}
                            <div className="h-32 flex items-end space-x-1 mt-6">
                                {moodEntries.slice(0, 7).reverse().map((entry, index) => (
                                    <div key={index} className="flex-1 flex flex-col items-center">
                                        <div 
                                            className="w-full bg-lavender rounded-t-lg transition-all duration-300"
                                            style={{ 
                                                height: `${entry.intensity * 8}%`,
                                                opacity: 0.3 + (entry.intensity / 10) * 0.7
                                            }}
                                        ></div>
                                        <div className="text-xs text-primary/40 mt-1">
                                            {new Date(entry.date).getDate()}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        <div className="text-sm text-primary/60">
                            éå»7å¤©çš„å¿ƒæƒ…è®ŠåŒ–è¶¨å‹¢
                        </div>
                    </div>
                </ProgressiveRevealContainer>
            );
        }
        
        // æ¨è–¦èª²ç¨‹å…ƒä»¶
        function RecommendedCourses({ onSelectCourse }) {
            const [recommendedCourses, setRecommendedCourses] = React.useState([]);
            
            React.useEffect(() => {
                // æ ¹æ“šæ™‚é–“æ¨è–¦èª²ç¨‹
                const hour = new Date().getHours();
                let courses = [];
                
                if (hour >= 21 || hour < 6) {
                    // å¤œé–“æ¨è–¦æ”¾é¬†èª²ç¨‹
                    courses = THERAPY_COURSES.filter(course => 
                        course.category === 'æ­£å¿µç·´ç¿’' || course.title.includes('å‘¼å¸')
                    );
                } else if (hour >= 18) {
                    // æ™šé–“æ¨è–¦åæ€èª²ç¨‹
                    courses = THERAPY_COURSES.filter(course => 
                        course.category === 'èªçŸ¥è¡Œç‚º'
                    );
                } else {
                    // æ—¥é–“æ¨è–¦æ´»åŠ›èª²ç¨‹
                    courses = THERAPY_COURSES;
                }
                
                setRecommendedCourses(courses.slice(0, 2));
            }, []);
            
            if (recommendedCourses.length === 0) return null;
            
            return (
                <ProgressiveRevealContainer threshold={0.2}>
                    <div className="card-apple p-6">
                        <h3 className="text-lg font-semibold text-primary mb-4">æ¨è–¦èª²ç¨‹</h3>
                        <div className="space-y-4">
                            {recommendedCourses.map((course, index) => (
                                <div 
                                    key={course.id}
                                    className="flex items-center p-4 border border-border-light/50 dark:border-border-dark rounded-xl hover:border-primary/30 transition-all duration-300"
                                >
                                    <div className={`w-10 h-10 rounded-xl bg-${course.color}/10 flex items-center justify-center mr-4`}>
                                        <span className="text-xl">{course.icon}</span>
                                    </div>
                                    <div className="flex-1">
                                        <h4 className="font-medium text-primary">{course.title}</h4>
                                        <p className="text-sm text-primary/50">{course.description}</p>
                                        <div className="flex items-center text-xs text-primary/40 mt-1">
                                            <span className="mr-3">â±ï¸ {course.duration}</span>
                                            <span>ğŸ“‹ {course.steps} æ­¥é©Ÿ</span>
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => onSelectCourse(course)}
                                        className="button-apple px-4 py-2 bg-slate-100 text-primary font-medium rounded-xl hover:bg-slate-200"
                                    >
                                        é–‹å§‹
                                    </button>
                                </div>
                            ))}
                        </div>
                    </div>
                </ProgressiveRevealContainer>
            );
        }
        
        // å„€è¡¨æ¿å…ƒä»¶
        function DashboardViewApple({ user, moodEntries, assessments, onNavigate }) {
            const recentMood = moodEntries.length > 0 ? moodEntries[0] : null;
            const [showAllContent, setShowAllContent] = React.useState(false);
            
            return (
                <div className="animate-fade-in">
                    <DashboardHero user={user} recentMood={recentMood} />
                    
                    {/* åˆå§‹å¯è¦‹å…§å®¹ */}
                    <div className="space-y-6">
                        {/* æ­·å²è¶¨å‹¢ - åˆå§‹é¡¯ç¤º */}
                        <HistoryTrends moodEntries={moodEntries} />
                        
                        {/* æ¨è–¦èª²ç¨‹ - æ²å‹•æ™‚é¡¯ç¤º */}
                        <RecommendedCourses onSelectCourse={(course) => onNavigate('courses', { focusCourse: course.id })} />
                    </div>
                </div>
            );
        }
        
        // å¿ƒæƒ…ç´€éŒ„å…ƒä»¶
        function MoodViewApple({ user, onMoodAdded }) {
            const [moodIntensity, setMoodIntensity] = React.useState(5);
            const [selectedTags, setSelectedTags] = React.useState([]);
            const [note, setNote] = React.useState('');
            const [moodEntries, setMoodEntries] = React.useState([]);
            
            React.useEffect(() => {
                loadMoodEntries();
            }, []);
            
            const loadMoodEntries = () => {
                const entries = JSON.parse(localStorage.getItem('souldiary_entries') || '[]')
                    .filter(entry => entry.userId === user.id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                setMoodEntries(entries);
            };
            
            const handleTagToggle = (tag) => {
                setSelectedTags(prev => 
                    prev.includes(tag) 
                        ? prev.filter(t => t !== tag)
                        : [...prev, tag]
                );
            };
            
            const handleSave = () => {
                if (selectedTags.length === 0) {
                    alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å¿ƒæƒ…æ¨™ç±¤');
                    return;
                }
                
                const newEntry = {
                    id: Date.now().toString(),
                    userId: user.id,
                    date: new Date().toISOString(),
                    intensity: moodIntensity,
                    tags: selectedTags,
                    note: note.trim()
                };
                
                const entries = JSON.parse(localStorage.getItem('souldiary_entries') || '[]');
                entries.push(newEntry);
                localStorage.setItem('souldiary_entries', JSON.stringify(entries));
                
                setMoodEntries([newEntry, ...moodEntries]);
                setSelectedTags([]);
                setNote('');
                setMoodIntensity(5);
                
                if (onMoodAdded) {
                    onMoodAdded();
                }
            };
            
            return (
                <div className="animate-fade-in">
                    <div className="mb-12">
                        <h1 className="text-3xl font-semibold tracking-tight text-primary mb-3">è¨˜éŒ„å¿ƒæƒ…</h1>
                        <p className="text-lg text-primary/60 tracking-wide">æ•æ‰ç•¶ä¸‹çš„æ„Ÿå—ï¼Œè¿½è¹¤æƒ…ç·’çš„æµå‹•</p>
                    </div>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-2 space-y-6">
                            {/* å¿ƒæƒ…å¼·åº¦å¡ç‰‡ */}
                            <div className="card-apple p-6" style={{ animationDelay: '0.1s' }}>
                                <h3 className="text-lg font-semibold text-primary mb-4">å¿ƒæƒ…å¼·åº¦</h3>
                                <div className="space-y-6">
                                    <div className="text-center">
                                        <div className="text-6xl font-semibold text-primary mb-2">{moodIntensity}</div>
                                        <div className="text-sm text-primary/40 tracking-wide">1-10åˆ†ï¼Œæ•¸å­—è¶Šå¤§è¡¨ç¤ºæƒ…ç·’è¶Šå¼·çƒˆ</div>
                                    </div>
                                    <input
                                        type="range"
                                        min="1"
                                        max="10"
                                        value={moodIntensity}
                                        onChange={(e) => setMoodIntensity(parseInt(e.target.value))}
                                        className="w-full h-1.5 bg-primary/10 rounded-full appearance-none [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:h-6 [&::-webkit-slider-thumb]:w-6 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-primary"
                                    />
                                    <div className="flex justify-between text-sm text-primary/50">
                                        <span>å¹³éœ</span>
                                        <span>ä¸­ç­‰</span>
                                        <span>å¼·çƒˆ</span>
                                    </div>
                                </div>
                            </div>
                            
                            {/* å¿ƒæƒ…æ¨™ç±¤å¡ç‰‡ */}
                            <div className="card-apple p-6" style={{ animationDelay: '0.2s' }}>
                                <h3 className="text-lg font-semibold text-primary mb-4">å¿ƒæƒ…æ¨™ç±¤</h3>
                                <div className="flex flex-wrap gap-2 mb-4">
                                    {MOOD_TAGS.map((tag, index) => (
                                        <button
                                            key={index}
                                            onClick={() => handleTagToggle(tag)}
                                            className={`button-apple px-4 py-2 text-sm font-medium rounded-full transition-all duration-300 ${
                                                selectedTags.includes(tag)
                                                    ? 'bg-lavender text-white'
                                                    : 'bg-slate-100 text-primary/70 hover:bg-slate-200 hover:text-primary'
                                            }`}
                                        >
                                            {tag}
                                        </button>
                                    ))}
                                </div>
                                <div className="text-sm text-primary/40 tracking-wide">
                                    å·²é¸æ“‡ {selectedTags.length} å€‹æ¨™ç±¤
                                </div>
                            </div>
                            
                            {/* å‚™è¨»å¡ç‰‡ */}
                            <div className="card-apple p-6" style={{ animationDelay: '0.3s' }}>
                                <h3 className="text-lg font-semibold text-primary mb-4">å¿ƒæƒ…å‚™è¨»</h3>
                                <textarea
                                    value={note}
                                    onChange={(e) => setNote(e.target.value)}
                                    rows="4"
                                    className="input-apple w-full"
                                    placeholder="æè¿°æ‚¨çš„å¿ƒæƒ…ã€è§¸ç™¼äº‹ä»¶æˆ–ä»»ä½•æƒ³æ³•..."
                                    maxLength="500"
                                />
                                <div className="mt-3 text-sm text-primary/40 tracking-wide">
                                    {note.length}/500 å­—å…ƒ
                                </div>
                            </div>
                            
                            <button
                                onClick={handleSave}
                                disabled={selectedTags.length === 0}
                                className="button-apple w-full py-3.5 px-4 bg-primary text-white font-medium rounded-2xl hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed"
                                style={{ animationDelay: '0.4s' }}
                            >
                                å„²å­˜å¿ƒæƒ…ç´€éŒ„
                            </button>
                        </div>
                        
                        {/* æ­·å²ç´€éŒ„å´æ¬„ */}
                        <div>
                            <div className="card-apple p-6 sticky top-24">
                                <h3 className="text-lg font-semibold text-primary mb-4">æœ€è¿‘ç´€éŒ„</h3>
                                {moodEntries.length === 0 ? (
                                    <div className="text-center py-8">
                                        <div className="text-3xl text-primary/20 mb-3">ğŸ“</div>
                                        <p className="text-primary/40">å°šæœªæœ‰ä»»ä½•ç´€éŒ„</p>
                                    </div>
                                ) : (
                                    <div className="space-y-4 max-h-[500px] overflow-y-auto scrollbar-apple">
                                        {moodEntries.slice(0, 10).map((entry, index) => (
                                            <div 
                                                key={entry.id} 
                                                className="p-4 border border-border-light/50 dark:border-border-dark rounded-xl"
                                                style={{ animationDelay: `${index * 0.05}s` }}
                                            >
                                                <div className="flex justify-between items-start mb-2">
                                                    <div className="text-sm text-primary/50">
                                                        {new Date(entry.date).toLocaleDateString('zh-TW')}
                                                    </div>
                                                    <div className="text-lg font-semibold text-primary">
                                                        {entry.intensity}/10
                                                    </div>
                                                </div>
                                                <div className="flex flex-wrap gap-1 mb-2">
                                                    {entry.tags?.slice(0, 2).map((tag, i) => (
                                                        <span key={i} className="px-2 py-1 text-xs tag-lavender rounded-full">
                                                            {tag}
                                                        </span>
                                                    ))}
                                                </div>
                                                {entry.note && (
                                                    <p className="text-sm text-primary/70 line-clamp-2">{entry.note}</p>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        
        // AI å°è©±å…ƒä»¶
        function ChatViewApple({ user }) {
            const [messages, setMessages] = React.useState([]);
            const [input, setInput] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [conversations, setConversations] = React.useState([]);
            const [activeConversation, setActiveConversation] = React.useState(null);
            const messagesEndRef = React.useRef(null);
            
            React.useEffect(() => {
                loadConversations();
            }, []);
            
            React.useEffect(() => {
                scrollToBottom();
            }, [messages]);
            
            const loadConversations = () => {
                const chats = JSON.parse(localStorage.getItem('souldiary_chats') || '{}');
                const userChats = chats[user.id] || [];
                setConversations(userChats);
                
                if (userChats.length > 0 && !activeConversation) {
                    setActiveConversation(userChats[0].id);
                    setMessages(userChats[0].messages);
                } else if (userChats.length === 0) {
                    createNewConversation();
                }
            };
            
            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };
            
            const createNewConversation = () => {
                const newConvId = Date.now().toString();
                const newConversation = {
                    id: newConvId,
                    title: 'æ–°çš„å°è©±',
                    createdAt: new Date().toISOString(),
                    messages: [
                        {
                            id: '1',
                            role: 'assistant',
                            content: '**æ‚¨å¥½ï¼Œæˆ‘æ˜¯æ‚¨çš„å¿ƒç†å°å¸«ã€‚** ä½œç‚ºä¸€ä½å…·å‚™è‡¨åºŠå¿ƒç†èƒŒæ™¯çš„å°ˆæ¥­å¤¥ä¼´ï¼Œæˆ‘æœƒä»¥æº«æš–ã€åŒç†å¿ƒçš„æ–¹å¼é™ªä¼´æ‚¨æ¢ç´¢å…§åœ¨ä¸–ç•Œã€‚\n\nä»Šå¤©æœ‰ä»€éº¼æˆ‘å¯ä»¥å”åŠ©æ‚¨çš„å—ï¼Ÿ',
                            timestamp: new Date().toISOString()
                        }
                    ]
                };
                
                const chats = JSON.parse(localStorage.getItem('souldiary_chats') || '{}');
                chats[user.id] = [...(chats[user.id] || []), newConversation];
                localStorage.setItem('souldiary_chats', JSON.stringify(chats));
                
                setConversations(chats[user.id]);
                setActiveConversation(newConvId);
                setMessages(newConversation.messages);
            };
            
            const handleSend = async () => {
                if (!input.trim() || loading) return;
                
                const userMessage = {
                    id: Date.now().toString(),
                    role: 'user',
                    content: input.trim(),
                    timestamp: new Date().toISOString()
                };
                
                const updatedMessages = [...messages, userMessage];
                setMessages(updatedMessages);
                setInput('');
                setLoading(true);
                
                try {
                    const aiResponse = await getGeminiResponse(input.trim(), updatedMessages);
                    
                    const aiMessage = {
                        id: (Date.now() + 1).toString(),
                        role: 'assistant',
                        content: aiResponse,
                        timestamp: new Date().toISOString()
                    };
                    
                    const finalMessages = [...updatedMessages, aiMessage];
                    setMessages(finalMessages);
                    updateConversationHistory(finalMessages);
                    
                } catch (error) {
                    console.error('AI å›æ‡‰éŒ¯èª¤:', error);
                    const errorMessage = {
                        id: (Date.now() + 1).toString(),
                        role: 'assistant',
                        content: 'æŠ±æ­‰ï¼Œæš«æ™‚ç„¡æ³•è™•ç†æ‚¨çš„è«‹æ±‚ã€‚è«‹ç¨å¾Œå†è©¦ï¼Œæˆ–è©¦è‘—é‡æ–°æ•´ç†é é¢ã€‚',
                        timestamp: new Date().toISOString()
                    };
                    
                    const finalMessages = [...updatedMessages, errorMessage];
                    setMessages(finalMessages);
                    updateConversationHistory(finalMessages);
                } finally {
                    setLoading(false);
                }
            };
            
            const updateConversationHistory = (messages) => {
                const chats = JSON.parse(localStorage.getItem('souldiary_chats') || '{}');
                const userChats = chats[user.id] || [];
                
                const updatedChats = userChats.map(conv => {
                    if (conv.id === activeConversation) {
                        const lastUserMessage = messages.findLast(msg => msg.role === 'user');
                        const newTitle = lastUserMessage 
                            ? lastUserMessage.content.substring(0, 30) + (lastUserMessage.content.length > 30 ? '...' : '')
                            : 'æ–°çš„å°è©±';
                        
                        return {
                            ...conv,
                            messages,
                            title: newTitle,
                            updatedAt: new Date().toISOString()
                        };
                    }
                    return conv;
                });
                
                chats[user.id] = updatedChats;
                localStorage.setItem('souldiary_chats', JSON.stringify(chats));
                setConversations(updatedChats);
            };
            
            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            };
            
            return (
                <div className="animate-fade-in">
                    <div className="mb-12">
                        <h1 className="text-3xl font-semibold tracking-tight text-primary mb-3">AI å¿ƒç†å°å¸«</h1>
                        <p className="text-lg text-primary/60 tracking-wide">èˆ‡å…·å‚™è‡¨åºŠå¿ƒç†èƒŒæ™¯çš„ AI å°å¸«å°è©±</p>
                    </div>
                    
                    <div className="flex h-[calc(100vh-240px)] border border-border-light/50 dark:border-border-dark rounded-2xl overflow-hidden bg-surface">
                        {/* å·¦å´å°è©±æ­·å² */}
                        <div className="w-64 border-r border-border-light/50 dark:border-border-dark bg-background/50">
                            <div className="p-4 border-b border-border-light/50 dark:border-border-dark">
                                <button
                                    onClick={createNewConversation}
                                    className="button-apple w-full py-2.5 px-3 bg-primary text-white font-medium rounded-2xl hover:opacity-90"
                                >
                                    é–‹å§‹æ–°å°è©±
                                </button>
                            </div>
                            <div className="p-2 overflow-y-auto h-[calc(100%-60px)] scrollbar-apple">
                                {conversations.map((conv, index) => (
                                    <button
                                        key={conv.id}
                                        onClick={() => {
                                            setActiveConversation(conv.id);
                                            setMessages(conv.messages);
                                        }}
                                        className={`button-apple w-full text-left p-3 rounded-xl mb-1 transition-all duration-300 ${
                                            activeConversation === conv.id
                                                ? 'bg-primary text-white'
                                                : 'text-primary/70 hover:bg-slate-100 hover:text-primary'
                                        }`}
                                        style={{ animationDelay: `${index * 0.05}s` }}
                                    >
                                        <div className="font-medium truncate text-sm">{conv.title}</div>
                                        <div className="text-xs opacity-70 mt-1">
                                            {new Date(conv.updatedAt || conv.createdAt).toLocaleDateString('zh-TW')}
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>
                        
                        {/* å³å´èŠå¤©å€åŸŸ */}
                        <div className="flex-1 flex flex-col">
                            <div className="flex-1 overflow-y-auto p-6 scrollbar-apple space-y-6">
                                {messages.map((msg, index) => (
                                    <div
                                        key={msg.id}
                                        className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
                                        style={{ animationDelay: `${index * 0.1}s` }}
                                    >
                                        <div
                                            className={`message-bubble-${msg.role} max-w-[70%] p-4`}
                                        >
                                            {msg.role === 'assistant' ? (
                                                <div 
                                                    className="markdown-content"
                                                    dangerouslySetInnerHTML={{ __html: marked.parse(msg.content) }}
                                                />
                                            ) : (
                                                <div className="whitespace-pre-wrap">{msg.content}</div>
                                            )}
                                            <div className="text-xs opacity-50 mt-2">
                                                {new Date(msg.timestamp).toLocaleTimeString('zh-TW', {
                                                    hour: '2-digit',
                                                    minute: '2-digit'
                                                })}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                
                                {loading && (
                                    <div className="flex justify-start">
                                        <div className="message-bubble-ai p-4">
                                            <div className="loading-dots-apple text-primary/50">
                                                <span></span><span></span><span></span>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                <div ref={messagesEndRef} />
                            </div>
                            
                            <div className="border-t border-border-light/50 dark:border-border-dark p-4">
                                <div className="flex space-x-3">
                                    <textarea
                                        value={input}
                                        onChange={(e) => setInput(e.target.value)}
                                        onKeyPress={handleKeyPress}
                                        placeholder="è¼¸å…¥æ‚¨çš„è¨Šæ¯..."
                                        rows="2"
                                        className="input-apple flex-1 resize-none"
                                    />
                                    <button
                                        onClick={handleSend}
                                        disabled={!input.trim() || loading}
                                        className="button-apple self-end px-5 py-2.5 bg-primary text-white font-medium rounded-2xl hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        å‚³é€
                                    </button>
                                </div>
                                <div className="mt-2 text-xs text-primary/40 tracking-wide">
                                    ç«¯å°ç«¯åŠ å¯† Â· æ‰€æœ‰å°è©±åƒ…å„²å­˜åœ¨æ‚¨çš„è£ç½®ä¸­
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        
        // æ•¸å­—æ²å‹•å…ƒä»¶
        function NumberScroll({ value, duration = 1500 }) {
            const [displayValue, setDisplayValue] = React.useState(0);
            
            React.useEffect(() => {
                let start = 0;
                const end = value;
                const incrementTime = duration / end;
                
                const timer = setInterval(() => {
                    start += 1;
                    setDisplayValue(start);
                    if (start >= end) {
                        clearInterval(timer);
                        setDisplayValue(end);
                    }
                }, incrementTime);
                
                return () => clearInterval(timer);
            }, [value, duration]);
            
            return (
                <div className="number-scroll-container">
                    <span className="number-scroll-digit">{displayValue}</span>
                </div>
            );
        }
        
        // é‡è¡¨è©•ä¼°å…ƒä»¶ - å®Œå…¨é‡æ§‹
        function AssessmentViewApple({ user }) {
            const [currentQuestionIndex, setCurrentQuestionIndex] = React.useState(-1); // -1 è¡¨ç¤ºé¡¯ç¤ºæ­¡è¿ç•«é¢
            const [answers, setAnswers] = React.useState({});
            const [showResult, setShowResult] = React.useState(false);
            const [assessmentHistory, setAssessmentHistory] = React.useState([]);
            const [isAnimating, setIsAnimating] = React.useState(false);
            const [finalScore, setFinalScore] = React.useState(0);
            
            React.useEffect(() => {
                loadAssessmentHistory();
            }, []);
            
            const loadAssessmentHistory = () => {
                const assessments = JSON.parse(localStorage.getItem('souldiary_assessments') || '[]')
                    .filter(a => a.userId === user.id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                setAssessmentHistory(assessments);
            };
            
            const handleStartAssessment = () => {
                setCurrentQuestionIndex(0);
            };
            
            const handleAnswerSelect = (value) => {
                if (isAnimating) return;
                
                setIsAnimating(true);
                
                // è¨˜éŒ„ç­”æ¡ˆ
                const newAnswers = {
                    ...answers,
                    [currentQuestionIndex]: parseInt(value)
                };
                setAnswers(newAnswers);
                
                // æª¢æŸ¥æ˜¯å¦æ˜¯æœ€å¾Œä¸€é¡Œ
                if (currentQuestionIndex === EPDS_QUESTIONS.length - 1) {
                    // è¨ˆç®—åˆ†æ•¸
                    const score = calculateEPDSScore(newAnswers);
                    setFinalScore(score);
                    
                    // å„²å­˜è©•ä¼°çµæœ
                    const result = getEPDSResult(score);
                    const newAssessment = {
                        id: Date.now().toString(),
                        userId: user.id,
                        date: new Date().toISOString(),
                        answers: { ...newAnswers },
                        score,
                        result: result.level
                    };
                    
                    const assessments = JSON.parse(localStorage.getItem('souldiary_assessments') || '[]');
                    assessments.unshift(newAssessment);
                    localStorage.setItem('souldiary_assessments', JSON.stringify(assessments));
                    
                    // é¡¯ç¤ºçµæœ
                    setTimeout(() => {
                        setShowResult(true);
                        setIsAnimating(false);
                    }, 500);
                    
                    return;
                }
                
                // ç§»å‹•åˆ°ä¸‹ä¸€é¡Œ
                setTimeout(() => {
                    setCurrentQuestionIndex(prev => prev + 1);
                    setIsAnimating(false);
                }, 300);
            };
            
            // æ­¡è¿ç•«é¢
            if (currentQuestionIndex === -1) {
                return (
                    <div className="min-h-[80vh] flex flex-col items-center justify-center animate-fade-in">
                        <div className="text-center max-w-2xl mx-auto px-4">
                            <div className="mb-8">
                                <div className="w-24 h-24 mx-auto mb-6 rounded-full bg-gradient-to-br from-sage/20 to-lavender/20 flex items-center justify-center breathing-light">
                                    <span className="text-4xl">ğŸŒ¿</span>
                                </div>
                                <h1 className="text-5xl font-semibold tracking-tight text-primary mb-4 animate-text-focus-in">
                                    æ¢ç´¢å…§åœ¨çš„å¹³è¡¡
                                </h1>
                                <p className="text-xl text-primary/60 mb-8 animate-text-focus-in" style={{ animationDelay: '0.2s' }}>
                                    æ„›ä¸å ¡æ†‚é¬±é‡è¡¨ (EPDS) è©•ä¼°
                                </p>
                            </div>
                            
                            <div className="card-apple p-8 mb-8 animate-fade-in-up" style={{ animationDelay: '0.4s' }}>
                                <div className="mb-6">
                                    <h2 className="text-2xl font-semibold text-primary mb-3">è©•ä¼°èªªæ˜</h2>
                                    <p className="text-primary/70 mb-4">
                                        é€™ä»½é‡è¡¨å°‡å¹«åŠ©æ‚¨äº†è§£éå»7å¤©çš„æƒ…ç·’ç‹€æ…‹ã€‚è«‹é¸æ“‡æœ€èƒ½åæ˜ æ‚¨çœŸå¯¦æ„Ÿå—çš„é¸é …ã€‚
                                    </p>
                                    <ul className="space-y-2 text-primary/60">
                                        <li className="flex items-start">
                                            <span className="mr-2">â€¢</span>
                                            <span>å…±æœ‰10å€‹å•é¡Œï¼Œç´„éœ€5åˆ†é˜å®Œæˆ</span>
                                        </li>
                                        <li className="flex items-start">
                                            <span className="mr-2">â€¢</span>
                                            <span>æ‰€æœ‰å›ç­”åƒ…å„²å­˜åœ¨æ‚¨çš„è£ç½®ä¸­ï¼Œå®Œå…¨ä¿å¯†</span>
                                        </li>
                                        <li className="flex items-start">
                                            <span className="mr-2">â€¢</span>
                                            <span>å®Œæˆå¾Œå°‡ç²å¾—å€‹äººåŒ–çš„å¿ƒç†å¥åº·å»ºè­°</span>
                                        </li>
                                    </ul>
                                </div>
                                
                                <button
                                    onClick={handleStartAssessment}
                                    className="button-apple w-full py-3.5 px-4 bg-primary text-white font-medium rounded-2xl hover:opacity-90"
                                >
                                    é–‹å§‹è©•ä¼°
                                </button>
                            </div>
                            
                            <div className="text-sm text-primary/40 animate-fade-in" style={{ animationDelay: '0.6s' }}>
                                è©•ä¼°çµæœåƒ…ä¾›åƒè€ƒï¼Œç„¡æ³•æ›¿ä»£å°ˆæ¥­é†«ç™‚å»ºè­°
                            </div>
                        </div>
                    </div>
                );
            }
            
            // çµæœç•«é¢
            if (showResult) {
                const result = getEPDSResult(finalScore);
                
                return (
                    <div className="animate-fade-in">
                        <div className="mb-12">
                            <h1 className="text-3xl font-semibold tracking-tight text-primary mb-3">è©•ä¼°çµæœ</h1>
                            <p className="text-lg text-primary/60 tracking-wide">æ„›ä¸å ¡æ†‚é¬±é‡è¡¨ (EPDS) è©•ä¼°çµæœ</p>
                        </div>
                        
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div className="space-y-6">
                                <div className={`card-apple p-6 ${result.bgColor} animate-fade-in-up`}>
                                    <div className="text-center mb-6">
                                        <div className="text-6xl font-semibold text-primary mb-2">
                                            <NumberScroll value={finalScore} />
                                        </div>
                                        <div className="text-primary/60 tracking-wide">ç¸½åˆ†ï¼ˆæ»¿åˆ†30ï¼‰</div>
                                    </div>
                                    <div className={`text-center text-2xl font-semibold mb-4 ${result.color}`}>
                                        {result.message}
                                    </div>
                                    <p className="text-center text-primary/70">{result.recommendation}</p>
                                </div>
                                
                                <div className="card-apple p-6 animate-fade-in-up" style={{ animationDelay: '0.1s' }}>
                                    <h3 className="text-lg font-semibold text-primary mb-4">å°ˆæ¥­å»ºè­°</h3>
                                    <ul className="space-y-3">
                                        <li className="flex items-start">
                                            <div className="w-5 h-5 rounded-full bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center mr-3 mt-0.5">
                                                <span className="text-emerald-600 dark:text-emerald-400 text-sm">âœ“</span>
                                            </div>
                                            <span className="text-primary/80">å®šæœŸè¨˜éŒ„å¿ƒæƒ…è®ŠåŒ–èˆ‡è§¸ç™¼äº‹ä»¶</span>
                                        </li>
                                        <li className="flex items-start">
                                            <div className="w-5 h-5 rounded-full bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center mr-3 mt-0.5">
                                                <span className="text-emerald-600 dark:text-emerald-400 text-sm">âœ“</span>
                                            </div>
                                            <span className="text-primary/80">å˜—è©¦ç™‚ç™’èª²ç¨‹ä¸­çš„æ­£å¿µç·´ç¿’</span>
                                        </li>
                                        {result.level === 'medium' && (
                                            <li className="flex items-start">
                                                <div className="w-5 h-5 rounded-full bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center mr-3 mt-0.5">
                                                    <span className="text-amber-600 dark:text-amber-400 text-sm">âš </span>
                                                </div>
                                                <span className="text-primary/80">è€ƒæ…®èˆ‡ä¿¡ä»»çš„äººåˆ†äº«æ„Ÿå—æˆ–å°‹æ±‚å¿ƒç†æ”¯æŒ</span>
                                            </li>
                                        )}
                                        {result.level === 'high' && (
                                            <li className="flex items-start">
                                                <div className="w-5 h-5 rounded-full bg-rose-100 dark:bg-rose-900/30 flex items-center justify-center mr-3 mt-0.5">
                                                    <span className="text-rose-600 dark:text-rose-400 text-sm">!</span>
                                                </div>
                                                <span className="text-primary/80">å»ºè­°å„˜å¿«å°‹æ±‚å°ˆæ¥­å¿ƒç†å¸«æˆ–ç²¾ç¥ç§‘é†«å¸«çš„å”åŠ©</span>
                                            </li>
                                        )}
                                    </ul>
                                </div>
                            </div>
                            
                            <div>
                                <div className="card-apple p-6 sticky top-24">
                                    <h3 className="text-lg font-semibold text-primary mb-4">è©•ä¼°æ­·å²</h3>
                                    {assessmentHistory.length === 0 ? (
                                        <div className="text-center py-8 text-primary/40">
                                            ç„¡æ­·å²ç´€éŒ„
                                        </div>
                                    ) : (
                                        <div className="space-y-3">
                                            {assessmentHistory.slice(0, 3).map((assessment, index) => (
                                                <div 
                                                    key={assessment.id} 
                                                    className="p-4 border border-border-light/50 dark:border-border-dark rounded-xl"
                                                    style={{ animationDelay: `${index * 0.1}s` }}
                                                >
                                                    <div className="flex justify-between items-center mb-1">
                                                        <div className="text-sm text-primary/60">
                                                            {new Date(assessment.date).toLocaleDateString('zh-TW')}
                                                        </div>
                                                        <div className={`text-lg font-semibold ${
                                                            assessment.score <= 9 ? 'text-emerald-600' :
                                                            assessment.score <= 12 ? 'text-amber-600' : 'text-rose-600'
                                                        }`}>
                                                            {assessment.score} åˆ†
                                                        </div>
                                                    </div>
                                                    <div className="text-xs text-primary/40 tracking-wide">
                                                        {assessment.score <= 9 ? 'è‰¯å¥½' :
                                                         assessment.score <= 12 ? 'é—œæ³¨' : 'å»ºè­°å”åŠ©'}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    <button
                                        onClick={() => {
                                            setShowResult(false);
                                            setCurrentQuestionIndex(-1);
                                            setAnswers({});
                                            setFinalScore(0);
                                        }}
                                        className="button-apple w-full mt-6 py-3 px-4 border border-border-light/50 dark:border-border-dark text-primary dark:text-white font-medium rounded-2xl hover:bg-slate-100 dark:hover:bg-white/5"
                                    >
                                        é‡æ–°è©•ä¼°
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
            
            // å•é¡Œç•«é¢
            const currentQuestion = EPDS_QUESTIONS[currentQuestionIndex];
            const progress = ((currentQuestionIndex + 1) / EPDS_QUESTIONS.length) * 100;
            
            return (
                <div className="min-h-[80vh] flex flex-col justify-center animate-fade-in">
                    <div className="max-w-2xl mx-auto w-full px-4">
                        {/* é€²åº¦æ¢ */}
                        <div className="mb-8">
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-sm text-primary/50">
                                    å•é¡Œ {currentQuestionIndex + 1} / {EPDS_QUESTIONS.length}
                                </span>
                                <span className="text-sm font-medium text-primary">
                                    {Math.round(progress)}%
                                </span>
                            </div>
                            <div className="capsule-progress">
                                <div 
                                    className="capsule-fill"
                                    style={{ width: `${progress}%` }}
                                ></div>
                            </div>
                        </div>
                        
                        {/* å•é¡Œå¡ç‰‡ */}
                        <div className={`card-apple p-8 mb-8 ${isAnimating ? 'question-slide-out' : 'question-slide-in'}`}>
                            <div className="flex items-start mb-8">
                                <div className="w-10 h-10 rounded-full bg-primary/5 flex items-center justify-center mr-4 flex-shrink-0">
                                    <span className="text-lg font-semibold text-primary">{currentQuestionIndex + 1}</span>
                                </div>
                                <h2 className="text-2xl font-semibold text-primary leading-tight">
                                    {currentQuestion}
                                </h2>
                            </div>
                            
                            <div className="space-y-3">
                                {[0, 1, 2, 3].map((value) => (
                                    <button
                                        key={value}
                                        onClick={() => handleAnswerSelect(value)}
                                        disabled={isAnimating}
                                        className={`button-apple w-full p-4 text-left border border-border-light/50 dark:border-border-dark rounded-xl transition-all duration-300 ${
                                            answers[currentQuestionIndex] === value
                                                ? 'border-primary bg-primary/5'
                                                : 'hover:border-primary/30'
                                        } ${isAnimating ? 'opacity-50' : ''}`}
                                    >
                                        <div className="flex items-center">
                                            <div className={`w-6 h-6 rounded-full border mr-3 flex items-center justify-center ${
                                                answers[currentQuestionIndex] === value
                                                    ? 'border-primary bg-primary'
                                                    : 'border-primary/30'
                                            }`}>
                                                {answers[currentQuestionIndex] === value && (
                                                    <div className="w-2 h-2 rounded-full bg-white"></div>
                                                )}
                                            </div>
                                            <span className="text-primary">
                                                {value === 0 ? 'å¾ä¸é€™æ¨£' :
                                                 value === 1 ? 'å¶çˆ¾é€™æ¨£' :
                                                 value === 2 ? 'ç¶“å¸¸é€™æ¨£' : 'ç¸½æ˜¯é€™æ¨£'}
                                            </span>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>
                        
                        <div className="text-center text-sm text-primary/40">
                            è«‹æ ¹æ“šéå»7å¤©çš„æ„Ÿå—é¸æ“‡æœ€é©åˆçš„é¸é …
                        </div>
                    </div>
                </div>
            );
        }
        
        // è¨­å®šé é¢å…ƒä»¶
        function SettingsViewApple({ user }) {
            const [exportData, setExportData] = React.useState('');
            const [showExport, setShowExport] = React.useState(false);
            const [showClearConfirm, setShowClearConfirm] = React.useState(false);
            
            const handleExportData = () => {
                const allData = {
                    user: JSON.parse(localStorage.getItem('souldiary_currentUser')),
                    moodEntries: JSON.parse(localStorage.getItem('souldiary_entries') || '[]')
                        .filter(entry => entry.userId === user.id),
                    assessments: JSON.parse(localStorage.getItem('souldiary_assessments') || '[]')
                        .filter(a => a.userId === user.id),
                    courses: JSON.parse(localStorage.getItem('souldiary_courses') || '[]')
                        .filter(c => c.userId === user.id),
                    chats: JSON.parse(localStorage.getItem('souldiary_chats') || '{}')[user.id] || []
                };
                
                const dataStr = JSON.stringify(allData, null, 2);
                setExportData(dataStr);
                setShowExport(true);
            };
            
            const handleDownloadData = () => {
                const element = document.createElement('a');
                const file = new Blob([exportData], { type: 'text/plain' });
                element.href = URL.createObjectURL(file);
                element.download = `souldiary-data-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            };
            
            const handleClearData = () => {
                localStorage.removeItem('souldiary_entries');
                localStorage.removeItem('souldiary_assessments');
                localStorage.removeItem('souldiary_courses');
                localStorage.removeItem('souldiary_chats');
                
                const chats = JSON.parse(localStorage.getItem('souldiary_chats') || '{}');
                delete chats[user.id];
                localStorage.setItem('souldiary_chats', JSON.stringify(chats));
                
                setShowClearConfirm(false);
                alert('æ‰€æœ‰å€‹äººè³‡æ–™å·²æ¸…é™¤');
            };
            
            return (
                <div className="animate-fade-in">
                    <div className="mb-12">
                        <h1 className="text-3xl font-semibold tracking-tight text-primary mb-3">è¨­å®š</h1>
                        <p className="text-lg text-primary/60 tracking-wide">ç®¡ç†æ‚¨çš„å¸³æˆ¶èˆ‡è³‡æ–™</p>
                    </div>
                    
                    <div className="max-w-2xl mx-auto">
                        {/* å¸³æˆ¶è³‡è¨Š */}
                        <div className="settings-section mb-8">
                            <div className="p-6 border-b border-border-light/50 dark:border-border-dark">
                                <h2 className="text-xl font-semibold text-primary">å¸³æˆ¶è³‡è¨Š</h2>
                            </div>
                            <div className="settings-item">
                                <div className="settings-item-content">
                                    <div className="settings-item-title">å§“å</div>
                                    <div className="settings-item-description">{user?.name}</div>
                                </div>
                            </div>
                            <div className="settings-item">
                                <div className="settings-item-content">
                                    <div className="settings-item-title">é›»å­éƒµä»¶</div>
                                    <div className="settings-item-description">{user?.email}</div>
                                </div>
                            </div>
                            <div className="settings-item">
                                <div className="settings-item-content">
                                    <div className="settings-item-title">è¨»å†Šæ—¥æœŸ</div>
                                    <div className="settings-item-description">
                                        {new Date(user?.createdAt).toLocaleDateString('zh-TW')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {/* è³‡æ–™ç®¡ç† */}
                        <div className="settings-section mb-8">
                            <div className="p-6 border-b border-border-light/50 dark:border-border-dark">
                                <h2 className="text-xl font-semibold text-primary">è³‡æ–™ç®¡ç†</h2>
                            </div>
                            <div className="settings-item">
                                <div className="settings-item-content">
                                    <div className="settings-item-title">åŒ¯å‡ºè³‡æ–™</div>
                                    <div className="settings-item-description">ä¸‹è¼‰æ‰€æœ‰å¿ƒæƒ…ç´€éŒ„ã€è©•ä¼°çµæœèˆ‡å°è©±ç´€éŒ„</div>
                                </div>
                                <button
                                    onClick={handleExportData}
                                    className="button-apple px-4 py-2 bg-slate-100 text-primary font-medium rounded-xl hover:bg-slate-200"
                                >
                                    åŒ¯å‡º
                                </button>
                            </div>
                            <div className="settings-item">
                                <div className="settings-item-content">
                                    <div className="settings-item-title">æ¸…é™¤è³‡æ–™</div>
                                    <div className="settings-item-description">åˆªé™¤æ‰€æœ‰å€‹äººè³‡æ–™ï¼Œä½†ä¿ç•™å¸³æˆ¶è³‡è¨Š</div>
                                </div>
                                <button
                                    onClick={() => setShowClearConfirm(true)}
                                    className="button-apple px-4 py-2 bg-rose-50 text-rose-600 font-medium rounded-xl hover:bg-rose-100"
                                >
                                    æ¸…é™¤
                                </button>
                            </div>
                        </div>
                        
                        {/* éš±ç§èˆ‡å®‰å…¨ */}
                        <div className="settings-section mb-8">
                            <div className="p-6 border-b border-border-light/50 dark:border-border-dark">
                                <h2 className="text-xl font-semibold text-primary">éš±ç§èˆ‡å®‰å…¨</h2>
                            </div>
                            <div className="settings-item">
                                <div className="settings-item-content">
                                    <div className="settings-item-title">ç«¯å°ç«¯åŠ å¯†</div>
                                    <div className="settings-item-description">æ‰€æœ‰è³‡æ–™åƒ…å„²å­˜åœ¨æ‚¨çš„è£ç½®ä¸­</div>
                                </div>
                                <div className="text-sm text-emerald-600 font-medium">å·²å•Ÿç”¨</div>
                            </div>
                            <div className="settings-item">
                                <div className="settings-item-content">
                                    <div className="settings-item-title">SHA-256 åŠ å¯†</div>
                                    <div className="settings-item-description">å¯†ç¢¼ä½¿ç”¨è»äº‹ç´šåŠ å¯†ä¿è­·</div>
                                </div>
                                <div className="text-sm text-emerald-600 font-medium">å·²å•Ÿç”¨</div>
                            </div>
                        </div>
                        
                        {/* é—œæ–¼ */}
                        <div className="settings-section mb-8">
                            <div className="p-6 border-b border-border-light/50 dark:border-border-dark">
                                <h2 className="text-xl font-semibold text-primary">é—œæ–¼ SoulDiary Pro</h2>
                            </div>
                            <div className="settings-item">
                                <div className="settings-item-content">
                                    <div className="settings-item-title">ç‰ˆæœ¬</div>
                                    <div className="settings-item-description">2.0.0</div>
                                </div>
                            </div>
                            <div className="settings-item">
                                <div className="settings-item-content">
                                    <div className="settings-item-title">æŠ€è¡“æ”¯æ´</div>
                                    <div className="settings-item-description">support@souldiary.com</div>
                                </div>
                            </div>
                            <div className="settings-item">
                                <div className="settings-item-content">
                                    <div className="settings-item-title">éš±ç§æ”¿ç­–</div>
                                    <div className="settings-item-description">ç«¯å°ç«¯åŠ å¯†ï¼Œè³‡æ–™æ°¸ä¸é›¢é–‹æ‚¨çš„è£ç½®</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* è³‡æ–™åŒ¯å‡ºæ¨¡æ…‹æ¡† */}
                    {showExport && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 animate-fade-in">
                            <div className="card-apple w-full max-w-2xl max-h-[80vh] overflow-hidden">
                                <div className="p-6 border-b border-border-light/50 dark:border-border-dark">
                                    <div className="flex items-center justify-between">
                                        <h3 className="text-xl font-semibold text-primary">åŒ¯å‡ºè³‡æ–™</h3>
                                        <button
                                            onClick={() => setShowExport(false)}
                                            className="button-apple p-2 text-primary/50 hover:text-primary"
                                        >
                                            âœ•
                                        </button>
                                    </div>
                                </div>
                                <div className="p-6">
                                    <div className="mb-4">
                                        <p className="text-primary/70 mb-2">æ‚¨çš„è³‡æ–™å·²æº–å‚™å¥½ä¸‹è¼‰ã€‚æ­¤æª”æ¡ˆåŒ…å«ï¼š</p>
                                        <ul className="list-disc pl-5 text-primary/60 space-y-1">
                                            <li>æ‰€æœ‰å¿ƒæƒ…ç´€éŒ„</li>
                                            <li>é‡è¡¨è©•ä¼°çµæœ</li>
                                            <li>èª²ç¨‹å®Œæˆé€²åº¦</li>
                                            <li>AIå°è©±ç´€éŒ„</li>
                                        </ul>
                                    </div>
                                    <div className="relative mb-6">
                                        <textarea
                                            value={exportData}
                                            readOnly
                                            rows="10"
                                            className="input-apple w-full font-mono text-sm"
                                        />
                                    </div>
                                    <div className="flex space-x-3">
                                        <button
                                            onClick={handleDownloadData}
                                            className="button-apple flex-1 py-3 px-4 bg-primary text-white font-medium rounded-2xl hover:opacity-90"
                                        >
                                            ä¸‹è¼‰ JSON æª”æ¡ˆ
                                        </button>
                                        <button
                                            onClick={() => setShowExport(false)}
                                            className="button-apple flex-1 py-3 px-4 border border-border-light/50 dark:border-border-dark text-primary dark:text-white font-medium rounded-2xl hover:bg-slate-100 dark:hover:bg-white/5"
                                        >
                                            é—œé–‰
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* æ¸…é™¤è³‡æ–™ç¢ºèªæ¨¡æ…‹æ¡† */}
                    {showClearConfirm && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 animate-fade-in">
                            <div className="card-apple w-full max-w-md">
                                <div className="p-6 border-b border-border-light/50 dark:border-border-dark">
                                    <h3 className="text-xl font-semibold text-primary">ç¢ºèªæ¸…é™¤è³‡æ–™</h3>
                                </div>
                                <div className="p-6">
                                    <div className="mb-6">
                                        <p className="text-primary/70 mb-3">
                                            <strong>è­¦å‘Šï¼š</strong>æ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤ä»¥ä¸‹è³‡æ–™ï¼š
                                        </p>
                                        <ul className="list-disc pl-5 text-primary/60 space-y-1">
                                            <li>æ‰€æœ‰å¿ƒæƒ…ç´€éŒ„</li>
                                            <li>é‡è¡¨è©•ä¼°çµæœ</li>
                                            <li>èª²ç¨‹å®Œæˆé€²åº¦</li>
                                            <li>AIå°è©±ç´€éŒ„</li>
                                        </ul>
                                        <p className="text-primary/70 mt-3">
                                            æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚æ‚¨ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ
                                        </p>
                                    </div>
                                    <div className="flex space-x-3">
                                        <button
                                            onClick={handleClearData}
                                            className="button-apple flex-1 py-3 px-4 bg-rose-600 text-white font-medium rounded-2xl hover:opacity-90"
                                        >
                                            ç¢ºèªæ¸…é™¤
                                        </button>
                                        <button
                                            onClick={() => setShowClearConfirm(false)}
                                            className="button-apple flex-1 py-3 px-4 border border-border-light/50 dark:border-border-dark text-primary dark:text-white font-medium rounded-2xl hover:bg-slate-100 dark:hover:bg-white/5"
                                        >
                                            å–æ¶ˆ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        
        // èª²ç¨‹é¡åˆ¥å¡ç‰‡å…ƒä»¶
        function CourseCategoryCard({ category, courses, isExpanded, onToggle, onSelectCourse }) {
            const categoryInfo = {
                'èªçŸ¥è¡Œç‚º': {
                    color: 'sage',
                    icon: 'ğŸ§ ',
                    description: 'èª¿æ•´æ€è€ƒæ¨¡å¼ï¼Œå»ºç«‹ç©æ¥µèªçŸ¥'
                },
                'æ­£å¿µç·´ç¿’': {
                    color: 'lavender',
                    icon: 'ğŸ§˜',
                    description: 'å°ˆæ³¨ç•¶ä¸‹ï¼ŒåŸ¹é¤Šè¦ºå¯Ÿèƒ½åŠ›'
                }
            };
            
            const info = categoryInfo[category] || { color: 'primary', icon: 'ğŸ“š', description: 'å¿ƒç†ç™‚ç™’èª²ç¨‹' };
            
            return (
                <div className="card-apple overflow-hidden">
                    <button
                        onClick={() => onToggle(category)}
                        className={`button-apple w-full p-6 text-left transition-all duration-300 ${
                            isExpanded ? 'bg-slate-100 dark:bg-white/5' : ''
                        }`}
                    >
                        <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-4">
                                <div className={`w-12 h-12 rounded-2xl bg-${info.color}/10 flex items-center justify-center`}>
                                    <span className="text-2xl">{info.icon}</span>
                                </div>
                                <div>
                                    <h3 className="text-xl font-semibold text-primary">{category}</h3>
                                    <p className="text-sm text-primary/60">{info.description}</p>
                                </div>
                            </div>
                            <div className={`transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}`}>
                                â†“
                            </div>
                        </div>
                    </button>
                    
                    {isExpanded && (
                        <div className="px-6 pb-6 animate-fade-in">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {courses.map((course, index) => (
                                    <div
                                        key={course.id}
                                        className="p-4 border border-border-light/50 dark:border-border-dark rounded-xl hover:border-primary/30 transition-all duration-300"
                                        style={{ animationDelay: `${index * 0.05}s` }}
                                    >
                                        <div className="flex items-start justify-between mb-3">
                                            <div>
                                                <h4 className="font-semibold text-primary mb-1">{course.title}</h4>
                                                <p className="text-sm text-primary/60">{course.description}</p>
                                            </div>
                                        </div>
                                        <div className="flex items-center justify-between text-sm text-primary/50 mb-4">
                                            <span>â±ï¸ {course.duration}</span>
                                            <span>ğŸ“‹ {course.steps} æ­¥é©Ÿ</span>
                                        </div>
                                        <button
                                            onClick={() => onSelectCourse(course)}
                                            className="button-apple w-full py-2 px-4 border border-border-light/50 dark:border-border-dark text-primary dark:text-white font-medium rounded-xl hover:bg-slate-100 dark:hover:bg-white/5"
                                        >
                                            é–‹å§‹ç·´ç¿’
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        
        // ç™‚ç™’èª²ç¨‹å…ƒä»¶
        function CoursesViewApple({ user, focusCourse }) {
            const [expandedCategory, setExpandedCategory] = React.useState(null);
            const [selectedCourse, setSelectedCourse] = React.useState(null);
            const [completedCourses, setCompletedCourses] = React.useState([]);
            
            React.useEffect(() => {
                loadCompletedCourses();
                
                // å¦‚æœæœ‰ç„¦é»èª²ç¨‹ï¼Œè‡ªå‹•å±•é–‹
                if (focusCourse) {
                    const course = THERAPY_COURSES.find(c => c.id === focusCourse);
                    if (course) {
                        setSelectedCourse(course);
                        setExpandedCategory(course.category);
                    }
                }
            }, [focusCourse]);
            
            const loadCompletedCourses = () => {
                const courses = JSON.parse(localStorage.getItem('souldiary_courses') || '[]')
                    .filter(c => c.userId === user.id && c.completed);
                setCompletedCourses(courses.map(c => c.courseId));
            };
            
            const handleToggleComplete = (courseId) => {
                const courses = JSON.parse(localStorage.getItem('souldiary_courses') || '[]');
                const existingIndex = courses.findIndex(c => c.userId === user.id && c.courseId === courseId);
                
                if (existingIndex >= 0) {
                    courses[existingIndex].completed = !courses[existingIndex].completed;
                    courses[existingIndex].updatedAt = new Date().toISOString();
                } else {
                    courses.push({
                        id: Date.now().toString(),
                        userId: user.id,
                        courseId,
                        completed: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                }
                
                localStorage.setItem('souldiary_courses', JSON.stringify(courses));
                loadCompletedCourses();
            };
            
            const categories = ['èªçŸ¥è¡Œç‚º', 'æ­£å¿µç·´ç¿’'];
            const coursesByCategory = categories.reduce((acc, category) => {
                acc[category] = THERAPY_COURSES.filter(course => course.category === category);
                return acc;
            }, {});
            
            const completedCount = completedCourses.length;
            const totalCount = THERAPY_COURSES.length;
            
            return (
                <div className="animate-fade-in">
                    <div className="mb-12">
                        <h1 className="text-3xl font-semibold tracking-tight text-primary mb-3">ç™‚ç™’èª²ç¨‹</h1>
                        <p className="text-lg text-primary/60 tracking-wide">åŸºæ–¼ç§‘å­¸é©—è­‰çš„å¿ƒç†æ²»ç™‚æ–¹æ³•</p>
                    </div>
                    
                    {/* é€²åº¦å¡ç‰‡ */}
                    <div className="card-apple p-6 mb-8" style={{ animationDelay: '0.1s' }}>
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <h3 className="text-lg font-semibold text-primary mb-1">å­¸ç¿’é€²åº¦</h3>
                                <p className="text-sm text-primary/50 tracking-wide">
                                    å®Œæˆ {completedCount} / {totalCount} å€‹èª²ç¨‹
                                </p>
                            </div>
                            <div className="text-2xl font-semibold text-primary">
                                {Math.round((completedCount / totalCount) * 100)}%
                            </div>
                        </div>
                        <div className="progress-bar-apple">
                            <div 
                                className="progress-fill-apple"
                                style={{ width: `${(completedCount / totalCount) * 100}%` }}
                            ></div>
                        </div>
                    </div>
                    
                    {/* èª²ç¨‹é¡åˆ¥å¡ç‰‡ */}
                    <div className="space-y-4">
                        {categories.map((category, index) => (
                            <CourseCategoryCard
                                key={category}
                                category={category}
                                courses={coursesByCategory[category]}
                                isExpanded={expandedCategory === category}
                                onToggle={(cat) => setExpandedCategory(expandedCategory === cat ? null : cat)}
                                onSelectCourse={setSelectedCourse}
                            />
                        ))}
                    </div>
                    
                    {/* é¸ä¸­èª²ç¨‹è©³æƒ… */}
                    {selectedCourse && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 animate-fade-in">
                            <div className="card-apple w-full max-w-2xl max-h-[80vh] overflow-y-auto scrollbar-apple">
                                <div className="p-6">
                                    <div className="flex items-center justify-between mb-6">
                                        <div className="flex items-center space-x-4">
                                            <div className={`w-12 h-12 rounded-2xl bg-${selectedCourse.color}/10 flex items-center justify-center`}>
                                                <span className="text-2xl">{selectedCourse.icon}</span>
                                            </div>
                                            <div>
                                                <h3 className="text-2xl font-semibold text-primary">{selectedCourse.title}</h3>
                                                <p className="text-primary/60">{selectedCourse.description}</p>
                                            </div>
                                        </div>
                                        <button
                                            onClick={() => setSelectedCourse(null)}
                                            className="button-apple p-2 text-primary/50 hover:text-primary"
                                        >
                                            âœ•
                                        </button>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-4 mb-6">
                                        <div className="p-4 border border-border-light/50 dark:border-border-dark rounded-xl">
                                            <div className="text-sm text-primary/50 mb-1">æ‰€éœ€æ™‚é–“</div>
                                            <div className="text-lg font-semibold text-primary">{selectedCourse.duration}</div>
                                        </div>
                                        <div className="p-4 border border-border-light/50 dark:border-border-dark rounded-xl">
                                            <div className="text-sm text-primary/50 mb-1">ç·´ç¿’æ­¥é©Ÿ</div>
                                            <div className="text-lg font-semibold text-primary">{selectedCourse.steps} æ­¥é©Ÿ</div>
                                        </div>
                                    </div>
                                    
                                    <div className="space-y-4 mb-8">
                                        <h4 className="text-lg font-semibold text-primary">ç·´ç¿’æ­¥é©Ÿ</h4>
                                        {Array.from({ length: selectedCourse.steps }).map((_, index) => (
                                            <div key={index} className="flex items-start space-x-3 p-3 border border-border-light/50 dark:border-border-dark rounded-xl">
                                                <div className="w-6 h-6 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0">
                                                    <span className="text-xs font-semibold text-primary">{index + 1}</span>
                                                </div>
                                                <p className="text-primary/80">
                                                    {index === 0 && "æ‰¾ä¸€å€‹å®‰éœèˆ’é©çš„ç©ºé–“ï¼Œç¢ºä¿ä¸å—æ‰“æ“¾"}
                                                    {index === 1 && "èª¿æ•´å‘¼å¸ï¼Œè®“èº«å¿ƒé€æ¼¸æ”¾é¬†ä¸‹ä¾†"}
                                                    {index === 2 && "æŒ‰ç…§æŒ‡ç¤ºé€²è¡Œæ ¸å¿ƒç·´ç¿’æ­¥é©Ÿ"}
                                                    {index === 3 && "è¨˜éŒ„ç·´ç¿’æ„Ÿå—ï¼Œå®Œæˆå¾Œæº«æŸ”åœ°å›åˆ°æ—¥å¸¸"}
                                                </p>
                                            </div>
                                        ))}
                                    </div>
                                    
                                    <div className="flex space-x-3">
                                        <button
                                            onClick={() => handleToggleComplete(selectedCourse.id)}
                                            className={`button-apple flex-1 py-3.5 px-4 font-medium rounded-2xl ${
                                                completedCourses.includes(selectedCourse.id)
                                                    ? 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 border border-emerald-200 dark:border-emerald-800'
                                                    : 'bg-primary text-white hover:opacity-90'
                                            }`}
                                        >
                                            {completedCourses.includes(selectedCourse.id) ? 'âœ“ å·²å®Œæˆ' : 'æ¨™è¨˜ç‚ºå®Œæˆ'}
                                        </button>
                                        <button
                                            onClick={() => setSelectedCourse(null)}
                                            className="button-apple flex-1 py-3.5 px-4 border border-border-light/50 dark:border-border-dark text-primary dark:text-white font-medium rounded-2xl hover:bg-slate-100 dark:hover:bg-white/5"
                                        >
                                            ç¨å¾Œé–‹å§‹
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        
        // é å°¾å…ƒä»¶
        function FooterApple() {
            return (
                <footer className="mt-20 border-t border-border-light/50 dark:border-border-dark">
                    <div className="container-apple py-8">
                        <div className="flex flex-col md:flex-row justify-between items-center">
                            <div className="mb-6 md:mb-0">
                                <LogoApple />
                                <p className="mt-4 text-sm text-primary/40 tracking-wide max-w-md">
                                    SoulDiary Pro æ˜¯ä¸€å€‹ç«¯å°ç«¯åŠ å¯†çš„å¿ƒç†å¥åº·å¹³å°ï¼Œæ‚¨çš„æ‰€æœ‰æ•¸æ“šéƒ½å®‰å…¨åœ°å„²å­˜åœ¨æœ¬åœ°è£ç½®ä¸­ã€‚
                                </p>
                            </div>
                            <div className="text-center md:text-right">
                                <p className="text-sm text-primary/40 tracking-wide">Â© 2025 SoulDiary Pro. éš±ç§å„ªå…ˆæŠ€è¡“ä¿è­‰</p>
                                <p className="mt-1 text-xs text-primary/30 tracking-widest">END-TO-END ENCRYPTED</p>
                            </div>
                        </div>
                    </div>
                </footer>
            );
        }
        
        // ä¸»æ‡‰ç”¨å…ƒä»¶
        function AppApple() {
            const [currentView, setCurrentView] = React.useState('dashboard');
            const [user, setUser] = React.useState(null);
            const [moodEntries, setMoodEntries] = React.useState([]);
            const [assessments, setAssessments] = React.useState([]);
            const [focusCourse, setFocusCourse] = React.useState(null);
            
            React.useEffect(() => {
                initializeStorage();
                checkAuth();
            }, []);
            
            React.useEffect(() => {
                if (user) {
                    loadUserData();
                }
            }, [user]);
            
            const checkAuth = () => {
                const savedUser = localStorage.getItem('souldiary_currentUser');
                if (savedUser) {
                    setUser(JSON.parse(savedUser));
                }
            };
            
            const loadUserData = () => {
                const entries = JSON.parse(localStorage.getItem('souldiary_entries') || '[]')
                    .filter(entry => entry.userId === user.id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                setMoodEntries(entries);
                
                const assessmentsData = JSON.parse(localStorage.getItem('souldiary_assessments') || '[]')
                    .filter(a => a.userId === user.id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                setAssessments(assessmentsData);
            };
            
            const handleLogin = (userData) => {
                setUser(userData);
                setCurrentView('dashboard');
            };
            
            const handleLogout = () => {
                localStorage.removeItem('souldiary_currentUser');
                setUser(null);
                setCurrentView('dashboard');
            };
            
            const handleMoodAdded = () => {
                loadUserData();
            };
            
            const handleNavigate = (view, params = {}) => {
                setCurrentView(view);
                if (params.focusCourse) {
                    setFocusCourse(params.focusCourse);
                }
            };
            
            // ç™»å…¥é é¢
            if (!user) {
                return <AuthViewApple onLogin={handleLogin} />;
            }
            
            // ä¸»æ‡‰ç”¨
            return (
                <div className="min-h-screen bg-background">
                    <NavbarApple 
                        user={user}
                        currentView={currentView}
                        onNavigate={handleNavigate}
                        onLogout={handleLogout}
                    />
                    
                    <main className="container-apple py-8">
                        {currentView === 'dashboard' && (
                            <DashboardViewApple 
                                user={user} 
                                moodEntries={moodEntries}
                                assessments={assessments}
                                onNavigate={handleNavigate}
                            />
                        )}
                        
                        {currentView === 'mood' && (
                            <MoodViewApple 
                                user={user}
                                onMoodAdded={handleMoodAdded}
                            />
                        )}
                        
                        {currentView === 'chat' && (
                            <ChatViewApple user={user} />
                        )}
                        
                        {currentView === 'assessment' && (
                            <AssessmentViewApple user={user} />
                        )}
                        
                        {currentView === 'courses' && (
                            <CoursesViewApple user={user} focusCourse={focusCourse} />
                        )}
                        
                        {currentView === 'settings' && (
                            <SettingsViewApple user={user} />
                        )}
                    </main>
                    
                    <FooterApple />
                </div>
            );
        }
        
        // æ¸²æŸ“æ‡‰ç”¨
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AppApple />);
    </script>
</body>
</html>
